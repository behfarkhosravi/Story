var app=function(){"use strict";function e(){}function t(e){return e()}function s(){return Object.create(null)}function n(e){e.forEach(t)}function r(e){return"function"==typeof e}function i(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function o(e,t){e.appendChild(t)}function a(e,t,s){e.insertBefore(t,s||null)}function l(e){e.parentNode&&e.parentNode.removeChild(e)}function c(e){return document.createElement(e)}function h(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function u(e){return document.createTextNode(e)}function d(){return u(" ")}function f(e,t,s,n){return e.addEventListener(t,s,n),()=>e.removeEventListener(t,s,n)}function p(e,t,s){null==s?e.removeAttribute(t):e.getAttribute(t)!==s&&e.setAttribute(t,s)}function g(e,t){t=""+t,e.data!==t&&(e.data=t)}function m(e,t){e.value=null==t?"":t}function v(e,t,s){e.classList[s?"add":"remove"](t)}let w;function y(e){w=e}function b(){if(!w)throw new Error("Function called outside component initialization");return w}function _(e){b().$$.on_mount.push(e)}function k(){const e=b();return(t,s,{cancelable:n=!1}={})=>{const r=e.$$.callbacks[t];if(r){const i=function(e,t,{bubbles:s=!1,cancelable:n=!1}={}){const r=document.createEvent("CustomEvent");return r.initCustomEvent(e,s,n,t),r}(t,s,{cancelable:n});return r.slice().forEach(t=>{t.call(e,i)}),!i.defaultPrevented}return!0}}const S=[],T=[];let E=[];const j=[],$=Promise.resolve();let O=!1;function P(e){E.push(e)}const C=new Set;let A=0;function x(){if(0!==A)return;const e=w;do{try{for(;A<S.length;){const e=S[A];A++,y(e),I(e.$$)}}catch(e){throw S.length=0,A=0,e}for(y(null),S.length=0,A=0;T.length;)T.pop()();for(let e=0;e<E.length;e+=1){const t=E[e];C.has(t)||(C.add(t),t())}E.length=0}while(S.length);for(;j.length;)j.pop()();O=!1,C.clear(),y(e)}function I(e){if(null!==e.fragment){e.update(),n(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(P)}}const R=new Set;let U;function L(){U={r:0,c:[],p:U}}function N(){U.r||n(U.c),U=U.p}function D(e,t){e&&e.i&&(R.delete(e),e.i(t))}function M(e,t,s,n){if(e&&e.o){if(R.has(e))return;R.add(e),U.c.push(()=>{R.delete(e),n&&(s&&e.d(1),n())}),e.o(t)}else n&&n()}function B(e,t){e.d(1),t.delete(e.key)}function q(e){e&&e.c()}function W(e,s,i,o){const{fragment:a,after_update:l}=e.$$;a&&a.m(s,i),o||P(()=>{const s=e.$$.on_mount.map(t).filter(r);e.$$.on_destroy?e.$$.on_destroy.push(...s):n(s),e.$$.on_mount=[]}),l.forEach(P)}function K(e,t){const s=e.$$;null!==s.fragment&&(!function(e){const t=[],s=[];E.forEach(n=>-1===e.indexOf(n)?t.push(n):s.push(n)),s.forEach(e=>e()),E=t}(s.after_update),n(s.on_destroy),s.fragment&&s.fragment.d(t),s.on_destroy=s.fragment=null,s.ctx=[])}function F(e,t){-1===e.$$.dirty[0]&&(S.push(e),O||(O=!0,$.then(x)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function z(t,r,i,o,a,c,h,u=[-1]){const d=w;y(t);const f=t.$$={fragment:null,ctx:[],props:c,update:e,not_equal:a,bound:s(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(r.context||(d?d.$$.context:[])),callbacks:s(),dirty:u,skip_bound:!1,root:r.target||d.$$.root};h&&h(f.root);let p=!1;if(f.ctx=i?i(t,r.props||{},(e,s,...n)=>{const r=n.length?n[0]:s;return f.ctx&&a(f.ctx[e],f.ctx[e]=r)&&(!f.skip_bound&&f.bound[e]&&f.bound[e](r),p&&F(t,e)),s}):[],f.update(),p=!0,n(f.before_update),f.fragment=!!o&&o(f.ctx),r.target){if(r.hydrate){const e=function(e){return Array.from(e.childNodes)}(r.target);f.fragment&&f.fragment.l(e),e.forEach(l)}else f.fragment&&f.fragment.c();r.intro&&D(t.$$.fragment),W(t,r.target,r.anchor,r.customElement),x()}y(d)}class G{$destroy(){K(this,1),this.$destroy=e}$on(t,s){if(!r(s))return e;const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(s),()=>{const e=n.indexOf(s);-1!==e&&n.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const H=[{page:1,content:"خانه همیشه ساکت بود، اما نه از آن سکوتی که آرامش‌بخش باشد. سنگین بود، مثل نفسی حبس‌شده، در انتظار شکستن چیزی. شیرین با قدم‌های محتاط در اتاق‌ها حرکت می‌کرد، پاهای برهنه‌اش روی چوب صیقلی سرد بود. هوا بوی هل و وعده‌های بیات‌شده می‌داد. هر روز صبح با همان برنامه بیدار می‌شد: چای دم می‌کرد، میز را می‌چید، و وقتی کاوه وارد می‌شد، لبخند می‌زد. چشمان کاوه، تیز مثل سنگ چخماق، او را نه برای عشق، که برای یافتن عیب‌هایش می‌کاوید. شیرین یاد گرفته بود خودش را کوچک کند، حضورش را کم‌رنگ و نامحسوس سازد. اما این اواخر، چیزی در درونش تکان می‌خورد - یک ناراحتی مبهم، مثل نخی که در گلویش گیر کرده باشد."},{page:2,content:"این ناراحتی را در لحظات کوچک حس می‌کرد. وقتی درباره‌ی روزش بیش از حد طولانی حرف می‌زد، لحن کاوه خشک می‌شد. وقتی ظرف‌هایی را که چیده بود، جابجا می‌کرد، انگار انتخاب‌هایش هیچ‌وقت کاملاً درست نبودند. یک بار به شوخی همسایه با صدای بلند خندیده بود و سکوت کاوه بعد از آن، مثل یک تیغ بود. به خودش می‌گفت این‌ها چیزی نیست. فقط این است که عشق بعد از سال‌ها این‌گونه جا می‌افتد. اما شب‌ها، وقتی بیدار دراز می‌کشید، سکوت خانه به سینه‌اش فشار می‌آورد. به ترک‌های سقف خیره می‌شد و فکر می‌کرد کی ظاهر شده‌اند. تقصیر او بود؟ تقصیر کاوه بود؟ یا تقصیر فضایی بود که بینشان ایجاد شده بود، فضایی که سردتر و وسیع‌تر می‌شد؟"},{page:3,content:"شیرین متوجه شد که بدنش هم دارد به او خیانت می‌کند. دست‌هایش هنگام ریختن چای او می‌لرزید. تصویرش در پنجره، نه از نظر جسمی، که از نظر روحی تکیده‌تر به نظر می‌رسید. وقتی کاوه از کنارش رد می‌شد، نفسش را حبس می‌کرد، منتظر یک کلمه، یک نگاه، هر چیزی که به او بگوید هنوز واقعی است. این ناراحتی بلند نبود - یک نجوا بود، سایه‌ای که در گوشه‌ی چشمش حرکت می‌کرد. هنوز نمی‌توانست نامی برایش پیدا کند، اما آنجا بود، مثل دود در هم می‌پیچید."},{page:4,content:"یک شب، وقتی برای شام جعفری خرد می‌کرد، چاقو از دستش در رفت و انگشتش را برید. قطره‌ای خون بیرون زد و او به آن خیره ماند. کاوه سرش را از روی گوشی‌اش بلند نکرد. با لحنی بی‌تفاوت گفت: «مواظب باش.» شیرین انگشتش را با پارچه‌ای بست، قلبش به شدت می‌تپید - نه از درد، که از آن وضوح ناگهانی: او داشت خون‌ریزی می‌کرد و کاوه نمی‌دید."},{page:5,content:"زخم انگشتش خوب شد، اما خاطره‌ی آن خون باقی ماند. دانه‌ی سرخی از شک بود که در زمین حاصلخیز ناراحتی‌اش کاشته شده بود. شیرین شروع به تماشای کاوه کرد، نه با نگاه نرم یک همسر، که با تمرکز تیز یک کارآگاه. می‌دید که لبخندهایش هرگز به چشمانش نمی‌رسد، که تعریف‌هایش همیشه با یک انتقاد ظریف همراه است. «این قورمه‌سبزی خوشمزه است، عزیزم،» می‌گفت، «اما شاید دفعه‌ی بعد کمی نمکش کمتر باشد.» کلمات بی‌ضرر بودند، اما مفهومشان همیشه آنجا بود: تو کاملاً خوب نیستی."},{page:6,content:"شروع به زیر سؤال بردن همه چیز کرد. زندگی‌ای که ساخته بودند، که زمانی مایه‌ی افتخارش بود، حالا مثل یک قفس به نظر می‌رسید. فرش‌های زیبا، مبلمان عتیقه، باغچه‌ی کاملاً مرتب - همه‌شان انتخاب‌ها و سلیقه‌های کاوه بودند. او فقط موافقت کرده بود، مشتاق راضی کردن، مشتاق همسر کامل بودن. اما «او» کجای این همه ماجرا بود؟ به دست‌هایش نگاه کرد، دست‌هایی که غذای او را می‌پخت و خانه‌اش را تمیز می‌کرد، و حس کرد دست‌های یک غریبه‌اند."},{page:7,content:"یک بعد از ظهر، وقتی کاوه سر کار بود، یک آلبوم عکس قدیمی در گوشه‌ای غبارآلود از اتاق زیر شیروانی پیدا کرد. مال قبل از آشنایی با کاوه بود. آنجا بود، با دوستانش می‌خندید، موهایش پریشان و رها، چشمانش پر از نوری که سال‌ها بود ندیده بود. آن موقع آدم دیگری بود، کسی که فضا را پر می‌کرد، کسی که نظر داشت، کسی که از بلند بودن صدایش نمی‌ترسید. تضاد آن‌قدر شدید بود که نفسش بند آمد. این زن در عکس که بود و چه بر سرش آمده بود؟"},{page:8,content:"شک در سینه‌اش چرکین شد، آتشی که آرام می‌سوزاند. شروع به جواب دادن کرد، به شکل‌های کوچک. یک شب با صدایی که کمی می‌لرزید گفت: «من نمکش را دوست دارم.» چشمان کاوه تنگ شد و سکوتی که بعد از آن حاکم شد آن‌قدر سنگین بود که شیرین می‌توانست فشارش را حس کند. اما کوتاه نیامد. یک پیروزی کوچک بود، اما مال خودش بود."},{page:9,content:"خانه، که زمانی نماد زندگی مشترکشان بود، حالا مثل موزه‌ای از زندگی‌ای بود که دیگر نمی‌خواستش. سکوت دیگر فقط سنگین نبود؛ خفه‌کننده بود. شروع به دیدن ترک‌ها کرد، نه فقط در سقف، که در خودِ پایه‌های رابطه‌شان. آن نخ نامرئی دیگر فقط یک حس نبود؛ یک طناب بود و دور گردنش پیچیده بود."},{page:10,content:"یک شب خواب دید در جنگلی از آینه‌هاست. در هر انعکاس، نسخه‌ی متفاوتی از خودش را می‌دید: دختری که در عکس بود، زنی که حالا بود، و صدها امکان دیگر. با تپش قلب از خواب پرید. فهمید که خوابش یک پیام بود. راه‌های دیگری هم بود، زندگی‌های دیگری که می‌توانست داشته باشد. این فکر هم ترسناک بود و هم هیجان‌انگیز. برای اولین بار بعد از مدت‌ها، جرقه‌ای از امید را حس کرد."},{page:11,content:"ترس، همراهی سرد و دائمی بود. سر میز شام کنارش می‌نشست، مهمانی ساکت و ناخوانده. جرقه‌ی امید از خوابش به سرعت با واقعیت تلخ زندگی‌اش خاموش شد. فکر ترک کردن کاوه مثل کوهی بود، به طرز غیرممکنی بلند، که قله‌اش در مه فرو رفته بود. چه کار می‌کرد؟ کجا می‌رفت؟ کاوه او را آن‌قدر هوشمندانه و کامل منزوی کرده بود که کسی را برای کمک نداشت. دوستانش دور شده بودند، خسته از بهانه‌هایش برای اینکه چرا نمی‌تواند آن‌ها را ببیند. خانواده‌اش در شهر دیگری زندگی می‌کردند و او همیشه تصویری از یک زندگی کامل برایشان ترسیم کرده بود."},{page:12,content:"شروع به پنهان کردن افکارش کرد، آن‌ها را در اعماق وجودش دفن می‌کرد. ذهنش تبدیل به یک باغ مخفی شد، جایی که می‌توانست خودش باشد، دور از نگاه منتقد کاوه. یک دفتر خاطرات شروع کرد، کتابچه‌ای کوچک با جلد چرمی که زیر یک تخته‌ی لق در کمدش پنهان می‌کرد. در صفحاتش، ترس‌ها، شک‌ها و رویاهایش را می‌ریخت. عمل نوشتن یک رهایی بود، راهی برای صدا دادن به فریادهای خاموش در سرش."},{page:13,content:"تناقضات در رفتار کاوه آشکارتر شد. برایش هدایای گران‌قیمت می‌خرید، بعد او را به خاطر مادی‌گرا بودن سرزنش می‌کرد. به او می‌گفت دوستش دارد، بعد روزها با او قهر می‌کرد. او استاد پیام‌های متناقض بود، استاد برهم زدن تعادل او، استاد اینکه کاری کند که شیرین حس کند اوست که دیوانه است. با صدایی آغشته به نگرانی دروغین می‌گفت: «تو خیلی حساسی. داری خیال‌بافی می‌کنی.»"},{page:14,content:"یک روز با یک دسته از گل‌های مورد علاقه‌اش، سوسن، به خانه آمد. با صدایی نرم مثل ابریشم گفت: «برای تو، عشقم.» شیرین می‌خواست باورش کند، آن را به عنوان یک حرکت عاشقانه ببیند. اما بعد رسید را روی پیشخوان آشپزخانه دید. از گلفروشی نزدیک دفترش بود، جایی که هیچ‌وقت نمی‌رفت. وحشتی سرد وجودش را فرا گرفت. گل‌ها برای او نبودند. پوششی بودند، راهی برای تسکین وجدان خودش درباره‌ی کاری که کرده بود."},{page:15,content:"با او روبرو نشد. ترس خیلی قوی بود. به جای آن، سوسن‌ها را در گلدان گذاشت و پژمرده شدن آرامشان را تماشا کرد، عطر شیرینشان یادآور تهوع‌آور دروغ‌هایش بود. سکوت خانه دیگر فقط سنگین نبود؛ تهدیدآمیز بود. سکوت یک شکارچی بود که طعمه‌اش را می‌پایید. و او طعمه بود."},{page:16,content:"نیاز به فرار تبدیل به دردی جسمی شد، گرسنگی‌ای که در شکمش می‌پیچید. با اعمال کوچک شورش شروع کرد، لحظات ریزی از آزادی که فقط مال خودش بود. از مسیر متفاوتی از فروشگاه به خانه می‌رفت، مسیری طولانی‌تر و خوش‌منظره‌تر که از پارکی که دوست داشت می‌گذشت. روی نیمکتی می‌نشست، زیر سایه‌ی یک درخت بلوط بزرگ، و به دنیای در حال گذر نگاه می‌کرد. برای چند دقیقه‌ی گران‌بها، او همسر کاوه نبود؛ فقط شیرین بود، زنی در یک پارک."},{page:17,content:"شروع به رفتن به کتابخانه کرد، جایی که سال‌ها بود نرفته بود. در میان قفسه‌ها گم می‌شد، احاطه‌شده با بوی آرامش‌بخش کتاب‌های قدیمی. حریصانه می‌خواند، هر چیزی که به دستش می‌رسید: رمان، شعر، روانشناسی. کتاب‌ها طناب نجاتی بودند، ارتباطی با دنیای خارج از خانه‌ی خفه‌کننده‌اش. به او یادآوری می‌کردند که راه‌های دیگری برای زندگی کردن، راه‌های دیگری برای بودن وجود دارد."},{page:18,content:"یک روز به کتابی درباره‌ی روابط سمی برخورد. همان‌طور که می‌خواند، شوکی از شناخت در وجودش دوید. توصیفات سوءاستفاده‌ی عاطفی، از بازی با روان، از کنترل - همه آنجا بود، آینه‌ای که زندگی خودش را منعکس می‌کرد. کتاب به آن وحشت بی‌نامی که سال‌ها او را آزار می‌داد، نامی داد. خیال‌بافی او نبود. واقعی بود."},{page:19,content:"فرارهای کوچکش جسورانه‌تر شد. در کلاس سفالگری ثبت‌نام کرد، کاری که همیشه دلش می‌خواست انجام دهد. به کاوه گفت به یک کلوپ کتاب‌خوانی می‌پیوندد. دروغ به طرز شگفت‌آوری آسان بود. کاوه آن‌قدر عادت کرده بود که او را بخشی از خودش بداند که سوالی نپرسید. کلاس سفالگری یک مکاشفه بود. حس کردن گِل در دستانش، عمل خلق کردن چیزی جدید، چیزی که مال خودش بود - مست‌کننده بود."},{page:20,content:"در کلاس سفالگری با زنی به نام لاله دوست شد. لاله همه چیزهایی بود که شیرین نبود: پر سر و صدا، با اعتماد به نفس، به شدت مستقل. ساعت‌ها بعد از کلاس با هم حرف می‌زدند، سر فنجان‌های چای در یک کافه‌ی کوچک و دنج. برای اولین بار بعد از سال‌ها، شیرین حس کرد دیده می‌شود، شنیده می‌شود، درک می‌شود. فرارهای کوچک دیگر فقط برای دور شدن از کاوه نبود؛ برای پیدا کردن راه بازگشت به خودش بود."},{page:21,content:"دوستی با لاله پنجره‌ای بود به زندگی‌ای که تقریباً فراموش کرده بود. داستان‌های لاله از سفرهایش، شغلش، علاقه‌هایش، شیرین را به یاد کسی می‌انداخت که قبلاً بود، کسی که زیر سال‌ها ترس و شک به خود دفن کرده بود. شروع به به یاد آوردن رویاهای خودش، جاه‌طلبی‌های خودش کرد. می‌خواست معلم شود، با بچه‌ها کار کند. خاطره آن‌قدر دور بود که انگار مال کس دیگری بود."},{page:22,content:"شروع به نگاه کردن به زندگی‌اش با چشمانی جدید کرد. خانه‌ی زیبا، که زمانی مایه‌ی افتخارش بود، حالا مثل یک قفس طلاکاری‌شده به نظر می‌رسید. لباس‌های گران‌قیمت، جواهرات، چیزهایی که کاوه برایش می‌خرید - آن‌ها هدیه‌های عشق نبودند؛ زنجیر بودند، او را به کاوه می‌بستند. او آزادی‌اش را با یک زندگی راحت معامله کرده بود، زندگی‌ای که آرام آرام او را خفه می‌کرد."},{page:23,content:"تصویر در آینه دیگر یک غریبه نبود. بارقه‌هایی از دختری که در عکس بود، دختری با موهای پریشان و چشمان درخشان را می‌دید. نور هنوز آنجا بود، جرقه‌ای ضعیف در تاریکی. شروع به پرورش آن کرد، به محافظت از آن، به دمیدن در آن تا شعله‌ور شود. شروع به آرایش موهایش به شکلی که قبلاً می‌کرد، به گوش دادن به موسیقی‌ای که دوست داشت، به پختن غذایی که از آن لذت می‌برد، حتی اگر کاوه دوست نداشت، کرد."},{page:24,content:"تغییرات کوچک بودند، تقریباً نامحسوس، اما مهم بودند. آن‌ها اعلامیه‌ی استقلال بودند، شورشی آرام علیه استبداد زندگی‌اش. او دیگر یک قربانی منفعل نبود؛ او یک بازمانده بود، زنی که آرام آرام، با زحمت، زندگی‌اش را پس می‌گرفت."},{page:25,content:"یک شب، وقتی برای خواب آماده می‌شد، در آینه به خودش نگاه کرد. برای اولین بار بعد از مدت‌ها، لبخند زد. لبخندی کوچک و مردد بود، اما واقعی بود. زن در آینه هم لبخند زد. سفر بازگشت به خودش آغاز شده بود."},{page:26,content:"دوستی با لاله یک کاتالیزور بود. لاله کبودی‌های روح شیرین را می‌دید، آن‌هایی که روی پوستش پیدا نبود. فشار نمی‌آورد، کنجکاوی نمی‌کرد، اما فضای امنی برای شیرین ایجاد می‌کرد تا حرف بزند، به اشتراک بگذارد، گره‌های درهم‌تنیده‌ی زندگی‌اش را باز کند. لاله با صدایی که مرهمی آرامش‌بخش بود می‌گفت: «تو قوی‌تر از آنی هستی که فکر می‌کنی.»"},{page:27,content:"از طریق لاله، شیرین با زنان دیگری آشنا شد، زنانی که آن‌ها هم دوران سختی را گذرانده بودند. آن‌ها قبیله‌ای از بازماندگان بودند، دایره‌ای از قدرت. داستان‌ها، تلاش‌ها و پیروزی‌هایشان را به اشتراک می‌گذاشتند. برای اولین بار، شیرین احساس تنهایی نمی‌کرد. او بخشی از یک جامعه بود، خواهرانی از زنانی که می‌فهمیدند."},{page:28,content:"دوباره شروع به خواندن کرد، نه فقط برای لذت، بلکه برای دانش. درباره‌ی وابستگی متقابل، درباره‌ی خودشیفتگی، درباره‌ی تروما خواند. کلمات روی صفحه یک مکاشفه بودند، یک نقشه‌ی راه برای درک تجربه‌ی خودش. مه غلیظ سردرگمی شروع به کنار رفتن کرد و جای خود را به نور شفاف درک داد."},{page:29,content:"صدای درونی‌اش، که مدت‌ها بود نجوایی ضعیف بود، شروع به بلندتر شدن کرد. صدای منطق، شجاعت و عشق به خود بود. به او می‌گفت که لایق بهتری است، که شایسته‌ی زندگی‌ای آزاد از ترس و کنترل است. صدای زنی بود که قرار بود باشد."},{page:30,content:"قدرتی که جمع می‌کرد، یک انفجار ناگهانی از شجاعت نبود، بلکه تجمعی آرام و پیوسته از پیروزی‌های کوچک بود. قدرت یک رودخانه بود که راه خود را از میان صخره‌ها باز می‌کند، قطره به قطره. هنوز برای رفتن آماده نبود، اما داشت به آنجا می‌رسید. دانه‌ی شک ریشه دوانده بود و در حال تبدیل شدن به درختی از قدرت بود."},{page:31,content:"اولین جدایی برنامه‌ریزی‌شده نبود. یک عمل خودجوش برای حفظ خود بود. کاوه چند روزی بود که حالش به شدت بد بود، کلماتش مثل خنجر، سکوتش پتویی خفه‌کننده. هوای خانه از خشمی ناگفته سنگین بود. شیرین حس می‌کرد دارد غرق می‌شود."},{page:32,content:"یک روز صبح، بعد از یک دعوای به خصوص شدید، کاوه برای کار رفت و در را پشت سرش کوبید. صدا در خانه پیچید، یک ضربه‌ی نهایی و وحشیانه. شیرین در سکوت ایستاد، بدنش می‌لرزید. و بعد، چیزی در درونش شکست. یک کیف کوچک بست، دست‌هایش با اراده‌ای از خودشان حرکت می‌کردند. فکر نمی‌کرد، فقط عمل می‌کرد."},{page:33,content:"به خانه‌ی لاله رفت. لاله در را باز کرد و وحشت را در چشمان شیرین دید. هیچ سؤالی نپرسید. فقط او را در آغوشی گرم گرفت و گفت: «اینجا امنی.» سه روز، شیرین پیش لاله ماند، می‌خوابید، گریه می‌کرد، حرف می‌زد. تسکین آن‌قدر عظیم بود که تقریباً دردناک بود. فراموش کرده بود امن بودن چه حسی دارد."},{page:34,content:"اما بعد احساس گناه شروع به خزیدن کرد. صدای کاوه در سرش می‌پیچید، به او می‌گفت که زیاده‌روی می‌کند، که ناسپاس است، که بدون او هیچ است. شروع به زنگ زدن، پیام دادن، التماس کردن کرد که به خانه برگردد. قول داد تغییر کند، بهتر شود. کلمات مثل آواز سیرن‌ها بودند، او را به سواحل آشنای زندانش می‌کشاندند."},{page:35,content:"برگشت. لحظه‌ای که پایش را در خانه گذاشت، فهمید که اشتباه کرده است. هوا هنوز از همان سم قدیمی سنگین بود. کاوه چند روزی شیرین بود، بعد الگوهای قدیمی برگشتند. اولین جدایی یک شکست بود، اما بیهوده نبود. به او طعم آزادی را چشانده بود، نگاهی اجمالی به زندگی‌ای بدون ترس. و آن طعم چیزی بود که هرگز فراموش نمی‌کرد."},{page:36,content:"فرار ناموفق یک درس بود، نه یک شکست. حالا می‌فهمید که رفتن یک عمل واحد نیست، بلکه یک فرآیند است. نیاز به برنامه‌ریزی، آمادگی و اراده‌ای آهنین داشت. دانه‌ی شک به درختی از قدرت تبدیل شده بود و حالا وقت آن بود که قلعه‌ای دور آن بسازد."},{page:37,content:"شروع به آماده شدن در خفا کرد. یک حساب بانکی به نام خودش باز کرد و مبالغ کمی پول نقد از بودجه‌ی خانه به آن واریز می‌کرد. از مدارک مهمش کپی گرفت: پاسپورت، شناسنامه، مدارک تحصیلی. آن‌ها را در جایی امن پنهان کرد، جایی که کاوه هرگز پیدا نمی‌کرد."},{page:38,content:"شروع به ساختن یک شبکه‌ی حمایتی کرد. با دوستان قدیمی‌اش، آن‌هایی که از خود رانده بود، دوباره ارتباط برقرار کرد. به آن‌ها حقیقت را گفت، تمام حقیقت زشت را. آن‌ها شوکه شدند، اما قضاوت نکردند. به او جایی برای ماندن، شانه‌ای برای گریه کردن، دستی برای گرفتن پیشنهاد دادند."},{page:39,content:"به کلاس سفالگری‌اش ادامه داد، نه فقط برای خلاقیت، بلکه برای حس اجتماعی که به او می‌داد. لاله و دوستان دیگرش طناب نجات او بودند، لنگرهای او در دریای طوفانی زندگی‌اش. به او یادآوری می‌کردند که تنها نیست، که دیوانه نیست، که مقصر نیست."},{page:40,content:"نقشه‌ی پنهانی یک باغ مخفی بود، جایی از امید در چشم‌انداز بایر زندگی‌اش. قولی بود که به خودش داده بود، قولی برای یک شروع جدید. ترس هنوز آنجا بود، یک همراه دائمی، اما دیگر یک نیروی فلج‌کننده نبود. یک انگیزه بود، یادآوری چیزی که برایش می‌جنگید: زندگی‌اش."},{page:41,content:"شبی که رفت، شبی بی‌مهتاب بود. تاریکی یک شنل بود، یک سپر. کاوه برای یک سفر کاری خارج از شهر بود، فرصتی نادر که منتظرش بود. کیفش بسته بود، مدارکش در کیفش بود، قلبش در گلویش می‌تپید. مثل یک روح در خانه حرکت می‌کرد، برای آخرین بار به زندگی‌ای که پشت سر می‌گذاشت نگاه می‌کرد."},{page:42,content:"خانه ساکت بود، اما حالا نوع دیگری از سکوت بود. سکوت یک صحنه‌ی خالی، سکوت داستانی که به پایانش رسیده بود. حس غمی به او دست داد، نه برای زندگی‌ای که ترک می‌کرد، بلکه برای زنی که در آن زندگی کرده بود، زنی که سال‌ها در سکوت رنج برده بود."},{page:43,content:"یادداشتی روی میز آشپزخانه گذاشت، یک پیام ساده و دو خطی: «من می‌روم. دنبالم نگرد.» کلمات اعلام جنگ بودند، یک عمل نهایی سرکشی. از در بیرون رفت و به پشت سرش نگاه نکرد. ترس دستی سرد روی شانه‌اش بود، اما به راه رفتن ادامه داد."},{page:44,content:"با اتوبوس به شهر دیگری رفت، جایی که می‌توانست ناشناس باشد، جایی که می‌توانست از نو شروع کند. سفر تاری از تاریکی و نورهای لرزان بود. حس عجیبی از وحشت و هیجان داشت. او یک فراری بود، یک فراری، زنی در حال فرار از زندگی خودش."},{page:45,content:"اما او همچنین زنی در سفری به سوی آزادی بود. راه پیش رو نامشخص بود، اما برای اولین بار بعد از مدت‌ها، مال خودش بود. نخ نامرئی بالاخره بریده شده بود."},{page:46,content:"چند ماه اول سخت بود. یک آپارتمان کوچک در محله‌ای آرام و کاری به عنوان پیشخدمت در یک کافه‌ی محلی پیدا کرد. کار سخت بود، حقوق کم بود، اما مال خودش بود. او مستقل بود، خودکفا، زنی که سرنوشت خودش را در دست داشت."},{page:47,content:"شروع به بهبودی کرد. زخم‌ها عمیق بودند، اما کشنده نبودند. به تراپی رفت، به یک گروه حمایتی پیوست، به دیدن دوستانش ادامه داد. یاد گرفت دوباره اعتماد کند، دوباره دوست بدارد، از خودش شروع کرد. زن در آینه دیگر یک غریبه نبود؛ یک دوست بود."},{page:48,content:"یک روز، نامه‌ای از یک وکیل دریافت کرد. کاوه درخواست طلاق داده بود. نامه یک قطع نهایی و رسمی از پیوندهایی بود که سال‌ها او را بسته بود. حس رهایی، حس خاتمه به او دست داد. گذشته بالاخره در گذشته بود."},{page:49,content:"راز بی‌رحمی کاوه هرگز به طور کامل حل نشد، اما او به برخی پاسخ‌ها رسید. از یک آشنای مشترک فهمید که او در خانه‌ای پر از خشونت و سوءاستفاده بزرگ شده است. بی‌رحمی او بازتاب ارزش او نبود، بلکه فرافکنی شیاطین درونی خودش بود. این رفتارش را توجیه نمی‌کرد، اما به او کمک کرد تا آن را بفهمد، تا خشم و سرزنش را رها کند."},{page:50,content:"او دوباره متولد شد. زنی که در خانه‌ی خودش زندانی بود، حالا یک زن آزاد بود، زنی که نویسنده‌ی داستان خودش بود. سفر طولانی و پر زحمت بود، اما ارزشش را داشت. او آرامش پیدا کرده بود، خودش را پیدا کرده بود، زندگی‌ای را پیدا کرده بود که واقعاً مال خودش بود."}];function J(t){let s;return{c(){s=c("header"),s.innerHTML='<div class="header-left"></div> \n  <div class="header-center svelte-1k0cbkj"><h1 class="svelte-1k0cbkj">نخ نامرئی</h1></div> \n  <div class="header-right svelte-1k0cbkj"></div>',p(s,"class","svelte-1k0cbkj")},m(e,t){a(e,s,t)},p:e,i:e,o:e,d(e){e&&l(s)}}}class V extends G{constructor(e){super(),z(this,e,null,J,i,{})}}class Y extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class X extends Y{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Q extends Y{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Z extends Y{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var ee;!function(e){e.Any="any",e.ApNortheast1="ap-northeast-1",e.ApNortheast2="ap-northeast-2",e.ApSouth1="ap-south-1",e.ApSoutheast1="ap-southeast-1",e.ApSoutheast2="ap-southeast-2",e.CaCentral1="ca-central-1",e.EuCentral1="eu-central-1",e.EuWest1="eu-west-1",e.EuWest2="eu-west-2",e.EuWest3="eu-west-3",e.SaEast1="sa-east-1",e.UsEast1="us-east-1",e.UsWest1="us-west-1",e.UsWest2="us-west-2"}(ee||(ee={}));var te=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};class se{constructor(e,{headers:t={},customFetch:s,region:n=ee.Any}={}){this.url=e,this.headers=t,this.region=n,this.fetch=(e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(function(){return ve}).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)})(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var s;return te(this,void 0,void 0,function*(){try{const{headers:n,method:r,body:i}=t;let o={},{region:a}=t;a||(a=this.region);const l=new URL(`${this.url}/${e}`);let c;a&&"any"!==a&&(o["x-region"]=a,l.searchParams.set("forceFunctionRegion",a)),i&&(n&&!Object.prototype.hasOwnProperty.call(n,"Content-Type")||!n)&&("undefined"!=typeof Blob&&i instanceof Blob||i instanceof ArrayBuffer?(o["Content-Type"]="application/octet-stream",c=i):"string"==typeof i?(o["Content-Type"]="text/plain",c=i):"undefined"!=typeof FormData&&i instanceof FormData?c=i:(o["Content-Type"]="application/json",c=JSON.stringify(i)));const h=yield this.fetch(l.toString(),{method:r||"POST",headers:Object.assign(Object.assign(Object.assign({},o),this.headers),n),body:c}).catch(e=>{throw new X(e)}),u=h.headers.get("x-relay-error");if(u&&"true"===u)throw new Q(h);if(!h.ok)throw new Z(h);let d,f=(null!==(s=h.headers.get("Content-Type"))&&void 0!==s?s:"text/plain").split(";")[0].trim();return d="application/json"===f?yield h.json():"application/octet-stream"===f?yield h.blob():"text/event-stream"===f?h:"multipart/form-data"===f?yield h.formData():yield h.text(),{data:d,error:null,response:h}}catch(e){return{data:null,error:e,response:e instanceof Z||e instanceof Q?e.context:void 0}}})}}var ne="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function re(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var s=function e(){if(this instanceof e){var s=[null];return s.push.apply(s,arguments),new(Function.bind.apply(t,s))}return t.apply(this,arguments)};s.prototype=t.prototype}else s={};return Object.defineProperty(s,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(s,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}),s}var ie={},oe={},ae={},le={},ce={},he={},ue=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();const de=ue.fetch;var fe=ue.fetch.bind(ue);const pe=ue.Headers,ge=ue.Request,me=ue.Response;var ve=Object.freeze({__proto__:null,Headers:pe,Request:ge,Response:me,default:fe,fetch:de}),we=re(ve),ye={};Object.defineProperty(ye,"__esModule",{value:!0});let be=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};ye.default=be;var _e=ne&&ne.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(he,"__esModule",{value:!0});const ke=_e(we),Se=_e(ye);he.default=class{constructor(e){var t,s;this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=new Headers(e.headers),this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=null!==(t=e.shouldThrowOnError)&&void 0!==t&&t,this.signal=e.signal,this.isMaybeSingle=null!==(s=e.isMaybeSingle)&&void 0!==s&&s,e.fetch?this.fetch=e.fetch:"undefined"==typeof fetch?this.fetch=ke.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=new Headers(this.headers),this.headers.set(e,t),this}then(e,t){void 0===this.schema||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),"GET"!==this.method&&"HEAD"!==this.method&&this.headers.set("Content-Type","application/json");let s=(0,this.fetch)(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async e=>{var t,s,n,r;let i=null,o=null,a=null,l=e.status,c=e.statusText;if(e.ok){if("HEAD"!==this.method){const s=await e.text();""===s||(o="text/csv"===this.headers.get("Accept")||this.headers.get("Accept")&&(null===(t=this.headers.get("Accept"))||void 0===t?void 0:t.includes("application/vnd.pgrst.plan+text"))?s:JSON.parse(s))}const r=null===(s=this.headers.get("Prefer"))||void 0===s?void 0:s.match(/count=(exact|planned|estimated)/),h=null===(n=e.headers.get("content-range"))||void 0===n?void 0:n.split("/");r&&h&&h.length>1&&(a=parseInt(h[1])),this.isMaybeSingle&&"GET"===this.method&&Array.isArray(o)&&(o.length>1?(i={code:"PGRST116",details:`Results contain ${o.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},o=null,a=null,l=406,c="Not Acceptable"):o=1===o.length?o[0]:null)}else{const t=await e.text();try{i=JSON.parse(t),Array.isArray(i)&&404===e.status&&(o=[],i=null,l=200,c="OK")}catch(s){404===e.status&&""===t?(l=204,c="No Content"):i={message:t}}if(i&&this.isMaybeSingle&&(null===(r=null==i?void 0:i.details)||void 0===r?void 0:r.includes("0 rows"))&&(i=null,l=200,c="OK"),i&&this.shouldThrowOnError)throw new Se.default(i)}return{error:i,data:o,count:a,status:l,statusText:c}});return this.shouldThrowOnError||(s=s.catch(e=>{var t,s,n;return{error:{message:`${null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"FetchError"}: ${null==e?void 0:e.message}`,details:`${null!==(s=null==e?void 0:e.stack)&&void 0!==s?s:""}`,hint:"",code:`${null!==(n=null==e?void 0:e.code)&&void 0!==n?n:""}`},data:null,count:null,status:0,statusText:""}})),s.then(e,t)}returns(){return this}overrideTypes(){return this}};var Te=ne&&ne.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ce,"__esModule",{value:!0});const Ee=Te(he);let je=class extends Ee.default{select(e){let t=!1;const s=(null!=e?e:"*").split("").map(e=>/\s/.test(e)&&!t?"":('"'===e&&(t=!t),e)).join("");return this.url.searchParams.set("select",s),this.headers.append("Prefer","return=representation"),this}order(e,{ascending:t=!0,nullsFirst:s,foreignTable:n,referencedTable:r=n}={}){const i=r?`${r}.order`:"order",o=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${o?`${o},`:""}${e}.${t?"asc":"desc"}${void 0===s?"":s?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:s=t}={}){const n=void 0===s?"limit":`${s}.limit`;return this.url.searchParams.set(n,`${e}`),this}range(e,t,{foreignTable:s,referencedTable:n=s}={}){const r=void 0===n?"offset":`${n}.offset`,i=void 0===n?"limit":`${n}.limit`;return this.url.searchParams.set(r,`${e}`),this.url.searchParams.set(i,""+(t-e+1)),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return"GET"===this.method?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:e=!1,verbose:t=!1,settings:s=!1,buffers:n=!1,wal:r=!1,format:i="text"}={}){var o;const a=[e?"analyze":null,t?"verbose":null,s?"settings":null,n?"buffers":null,r?"wal":null].filter(Boolean).join("|"),l=null!==(o=this.headers.get("Accept"))&&void 0!==o?o:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${i}; for="${l}"; options=${a};`),this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(e){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${e}`),this}};ce.default=je;var $e=ne&&ne.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(le,"__esModule",{value:!0});const Oe=$e(ce);let Pe=class extends Oe.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const s=Array.from(new Set(t)).map(e=>"string"==typeof e&&new RegExp("[,()]").test(e)?`"${e}"`:`${e}`).join(",");return this.url.searchParams.append(e,`in.(${s})`),this}contains(e,t){return"string"==typeof t?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return"string"==typeof t?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return"string"==typeof t?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:s,type:n}={}){let r="";"plain"===n?r="pl":"phrase"===n?r="ph":"websearch"===n&&(r="w");const i=void 0===s?"":`(${s})`;return this.url.searchParams.append(e,`${r}fts${i}.${t}`),this}match(e){return Object.entries(e).forEach(([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)}),this}not(e,t,s){return this.url.searchParams.append(e,`not.${t}.${s}`),this}or(e,{foreignTable:t,referencedTable:s=t}={}){const n=s?`${s}.or`:"or";return this.url.searchParams.append(n,`(${e})`),this}filter(e,t,s){return this.url.searchParams.append(e,`${t}.${s}`),this}};le.default=Pe;var Ce=ne&&ne.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ae,"__esModule",{value:!0});const Ae=Ce(le);ae.default=class{constructor(e,{headers:t={},schema:s,fetch:n}){this.url=e,this.headers=new Headers(t),this.schema=s,this.fetch=n}select(e,{head:t=!1,count:s}={}){const n=t?"HEAD":"GET";let r=!1;const i=(null!=e?e:"*").split("").map(e=>/\s/.test(e)&&!r?"":('"'===e&&(r=!r),e)).join("");return this.url.searchParams.set("select",i),s&&this.headers.append("Prefer",`count=${s}`),new Ae.default({method:n,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(e,{count:t,defaultToNull:s=!0}={}){var n;if(t&&this.headers.append("Prefer",`count=${t}`),s||this.headers.append("Prefer","missing=default"),Array.isArray(e)){const t=e.reduce((e,t)=>e.concat(Object.keys(t)),[]);if(t.length>0){const e=[...new Set(t)].map(e=>`"${e}"`);this.url.searchParams.set("columns",e.join(","))}}return new Ae.default({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:null!==(n=this.fetch)&&void 0!==n?n:fetch})}upsert(e,{onConflict:t,ignoreDuplicates:s=!1,count:n,defaultToNull:r=!0}={}){var i;if(this.headers.append("Prefer",`resolution=${s?"ignore":"merge"}-duplicates`),void 0!==t&&this.url.searchParams.set("on_conflict",t),n&&this.headers.append("Prefer",`count=${n}`),r||this.headers.append("Prefer","missing=default"),Array.isArray(e)){const t=e.reduce((e,t)=>e.concat(Object.keys(t)),[]);if(t.length>0){const e=[...new Set(t)].map(e=>`"${e}"`);this.url.searchParams.set("columns",e.join(","))}}return new Ae.default({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:null!==(i=this.fetch)&&void 0!==i?i:fetch})}update(e,{count:t}={}){var s;return t&&this.headers.append("Prefer",`count=${t}`),new Ae.default({method:"PATCH",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:null!==(s=this.fetch)&&void 0!==s?s:fetch})}delete({count:e}={}){var t;return e&&this.headers.append("Prefer",`count=${e}`),new Ae.default({method:"DELETE",url:this.url,headers:this.headers,schema:this.schema,fetch:null!==(t=this.fetch)&&void 0!==t?t:fetch})}};var xe=ne&&ne.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(oe,"__esModule",{value:!0});const Ie=xe(ae),Re=xe(le);oe.default=class e{constructor(e,{headers:t={},schema:s,fetch:n}={}){this.url=e,this.headers=new Headers(t),this.schemaName=s,this.fetch=n}from(e){const t=new URL(`${this.url}/${e}`);return new Ie.default(t,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(t){return new e(this.url,{headers:this.headers,schema:t,fetch:this.fetch})}rpc(e,t={},{head:s=!1,get:n=!1,count:r}={}){var i;let o;const a=new URL(`${this.url}/rpc/${e}`);let l;s||n?(o=s?"HEAD":"GET",Object.entries(t).filter(([e,t])=>void 0!==t).map(([e,t])=>[e,Array.isArray(t)?`{${t.join(",")}}`:`${t}`]).forEach(([e,t])=>{a.searchParams.append(e,t)})):(o="POST",l=t);const c=new Headers(this.headers);return r&&c.set("Prefer",`count=${r}`),new Re.default({method:o,url:a,headers:c,schema:this.schemaName,body:l,fetch:null!==(i=this.fetch)&&void 0!==i?i:fetch})}};var Ue=ne&&ne.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ie,"__esModule",{value:!0}),ie.PostgrestError=ie.PostgrestBuilder=ie.PostgrestTransformBuilder=ie.PostgrestFilterBuilder=ie.PostgrestQueryBuilder=ie.PostgrestClient=void 0;const Le=Ue(oe);ie.PostgrestClient=Le.default;const Ne=Ue(ae);ie.PostgrestQueryBuilder=Ne.default;const De=Ue(le);ie.PostgrestFilterBuilder=De.default;const Me=Ue(ce);ie.PostgrestTransformBuilder=Me.default;const Be=Ue(he);ie.PostgrestBuilder=Be.default;const qe=Ue(ye);ie.PostgrestError=qe.default;var We=ie.default={PostgrestClient:Le.default,PostgrestQueryBuilder:Ne.default,PostgrestFilterBuilder:De.default,PostgrestTransformBuilder:Me.default,PostgrestBuilder:Be.default,PostgrestError:qe.default};const{PostgrestClient:Ke,PostgrestQueryBuilder:Fe,PostgrestFilterBuilder:ze,PostgrestTransformBuilder:Ge,PostgrestBuilder:He,PostgrestError:Je}=We;class Ve{static detectEnvironment(){var e;if("undefined"!=typeof WebSocket)return{type:"native",constructor:WebSocket};if("undefined"!=typeof globalThis&&void 0!==globalThis.WebSocket)return{type:"native",constructor:globalThis.WebSocket};if("undefined"!=typeof global&&void 0!==global.WebSocket)return{type:"native",constructor:global.WebSocket};if("undefined"!=typeof globalThis&&void 0!==globalThis.WebSocketPair&&void 0===globalThis.WebSocket)return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if("undefined"!=typeof globalThis&&globalThis.EdgeRuntime||"undefined"!=typeof navigator&&(null===(e=navigator.userAgent)||void 0===e?void 0:e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if("undefined"!=typeof process){const e=process.versions;if(e&&e.node){const t=e.node,s=parseInt(t.replace(/^v/,"").split(".")[0]);return s>=22?void 0!==globalThis.WebSocket?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${s} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${s} detected without native WebSocket support.`,workaround:'For Node.js < 22, install "ws" package and provide it via the transport option:\nimport ws from "ws"\nnew RealtimeClient(url, { transport: ws })'}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`\n\nSuggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){return new(this.getWebSocketConstructor())(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return"native"===e.type||"ws"===e.type}catch(e){return!1}}}const Ye=1e4;var Xe,Qe,Ze,et,tt,st;!function(e){e[e.connecting=0]="connecting",e[e.open=1]="open",e[e.closing=2]="closing",e[e.closed=3]="closed"}(Xe||(Xe={})),function(e){e.closed="closed",e.errored="errored",e.joined="joined",e.joining="joining",e.leaving="leaving"}(Qe||(Qe={})),function(e){e.close="phx_close",e.error="phx_error",e.join="phx_join",e.reply="phx_reply",e.leave="phx_leave",e.access_token="access_token"}(Ze||(Ze={})),function(e){e.websocket="websocket"}(et||(et={})),function(e){e.Connecting="connecting",e.Open="open",e.Closing="closing",e.Closed="closed"}(tt||(tt={}));class nt{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t("string"==typeof e?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,t,s)}_decodeBroadcast(e,t,s){const n=t.getUint8(1),r=t.getUint8(2);let i=this.HEADER_LENGTH+2;const o=s.decode(e.slice(i,i+n));i+=n;const a=s.decode(e.slice(i,i+r));i+=r;return{ref:null,topic:o,event:a,payload:JSON.parse(s.decode(e.slice(i,e.byteLength)))}}}class rt{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}!function(e){e.abstime="abstime",e.bool="bool",e.date="date",e.daterange="daterange",e.float4="float4",e.float8="float8",e.int2="int2",e.int4="int4",e.int4range="int4range",e.int8="int8",e.int8range="int8range",e.json="json",e.jsonb="jsonb",e.money="money",e.numeric="numeric",e.oid="oid",e.reltime="reltime",e.text="text",e.time="time",e.timestamp="timestamp",e.timestamptz="timestamptz",e.timetz="timetz",e.tsrange="tsrange",e.tstzrange="tstzrange"}(st||(st={}));const it=(e,t,s={})=>{var n;const r=null!==(n=s.skipTypes)&&void 0!==n?n:[];return Object.keys(t).reduce((s,n)=>(s[n]=ot(n,e,t,r),s),{})},ot=(e,t,s,n)=>{const r=t.find(t=>t.name===e),i=null==r?void 0:r.type,o=s[e];return i&&!n.includes(i)?at(i,o):lt(o)},at=(e,t)=>{if("_"===e.charAt(0)){const s=e.slice(1,e.length);return dt(t,s)}switch(e){case st.bool:return ct(t);case st.float4:case st.float8:case st.int2:case st.int4:case st.int8:case st.numeric:case st.oid:return ht(t);case st.json:case st.jsonb:return ut(t);case st.timestamp:return ft(t);case st.abstime:case st.date:case st.daterange:case st.int4range:case st.int8range:case st.money:case st.reltime:case st.text:case st.time:case st.timestamptz:case st.timetz:case st.tsrange:case st.tstzrange:default:return lt(t)}},lt=e=>e,ct=e=>{switch(e){case"t":return!0;case"f":return!1;default:return e}},ht=e=>{if("string"==typeof e){const t=parseFloat(e);if(!Number.isNaN(t))return t}return e},ut=e=>{if("string"==typeof e)try{return JSON.parse(e)}catch(t){return console.log(`JSON parse error: ${t}`),e}return e},dt=(e,t)=>{if("string"!=typeof e)return e;const s=e.length-1,n=e[s];if("{"===e[0]&&"}"===n){let n;const r=e.slice(1,s);try{n=JSON.parse("["+r+"]")}catch(e){n=r?r.split(","):[]}return n.map(e=>at(t,e))}return e},ft=e=>"string"==typeof e?e.replace(" ","T"):e,pt=e=>{let t=e;return t=t.replace(/^ws/i,"http"),t=t.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),t.replace(/\/+$/,"")+"/api/broadcast"};class gt{constructor(e,t,s={},n=1e4){this.channel=e,this.event=t,this.payload=s,this.timeout=n,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t(null===(s=this.receivedResp)||void 0===s?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);this.channel._on(this.refEvent,{},e=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=e,this._matchReceive(e)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(t=>t.status===e).forEach(e=>e.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var mt,vt,wt,yt;!function(e){e.SYNC="sync",e.JOIN="join",e.LEAVE="leave"}(mt||(mt={}));class bt{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(null==t?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},e=>{const{onJoin:t,onLeave:s,onSync:n}=this.caller;this.joinRef=this.channel._joinRef(),this.state=bt.syncState(this.state,e,t,s),this.pendingDiffs.forEach(e=>{this.state=bt.syncDiff(this.state,e,t,s)}),this.pendingDiffs=[],n()}),this.channel._on(s.diff,{},e=>{const{onJoin:t,onLeave:s,onSync:n}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(e):(this.state=bt.syncDiff(this.state,e,t,s),n())}),this.onJoin((e,t,s)=>{this.channel._trigger("presence",{event:"join",key:e,currentPresences:t,newPresences:s})}),this.onLeave((e,t,s)=>{this.channel._trigger("presence",{event:"leave",key:e,currentPresences:t,leftPresences:s})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,s,n){const r=this.cloneDeep(e),i=this.transformState(t),o={},a={};return this.map(r,(e,t)=>{i[e]||(a[e]=t)}),this.map(i,(e,t)=>{const s=r[e];if(s){const n=t.map(e=>e.presence_ref),r=s.map(e=>e.presence_ref),i=t.filter(e=>r.indexOf(e.presence_ref)<0),l=s.filter(e=>n.indexOf(e.presence_ref)<0);i.length>0&&(o[e]=i),l.length>0&&(a[e]=l)}else o[e]=t}),this.syncDiff(r,{joins:o,leaves:a},s,n)}static syncDiff(e,t,s,n){const{joins:r,leaves:i}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),n||(n=()=>{}),this.map(r,(t,n)=>{var r;const i=null!==(r=e[t])&&void 0!==r?r:[];if(e[t]=this.cloneDeep(n),i.length>0){const s=e[t].map(e=>e.presence_ref),n=i.filter(e=>s.indexOf(e.presence_ref)<0);e[t].unshift(...n)}s(t,i,n)}),this.map(i,(t,s)=>{let r=e[t];if(!r)return;const i=s.map(e=>e.presence_ref);r=r.filter(e=>i.indexOf(e.presence_ref)<0),e[t]=r,n(t,r,s),0===r.length&&delete e[t]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,s)=>{const n=e[s];return t[s]="metas"in n?n.metas.map(e=>(e.presence_ref=e.phx_ref,delete e.phx_ref,delete e.phx_ref_prev,e)):n,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}!function(e){e.ALL="*",e.INSERT="INSERT",e.UPDATE="UPDATE",e.DELETE="DELETE"}(vt||(vt={})),function(e){e.BROADCAST="broadcast",e.PRESENCE="presence",e.POSTGRES_CHANGES="postgres_changes",e.SYSTEM="system"}(wt||(wt={})),function(e){e.SUBSCRIBED="SUBSCRIBED",e.TIMED_OUT="TIMED_OUT",e.CLOSED="CLOSED",e.CHANNEL_ERROR="CHANNEL_ERROR"}(yt||(yt={}));class _t{constructor(e,t={config:{}},s){this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=Qe.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new gt(this,Ze.join,this.params,this.timeout),this.rejoinTimer=new rt(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=Qe.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(e=>e.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=Qe.closed,this.socket._remove(this)}),this._onError(e=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,e),this.state=Qe.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=Qe.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",e=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,e),this.state=Qe.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Ze.reply,{},(e,t)=>{this._trigger(this._replyEventName(t),e)}),this.presence=new bt(this),this.broadcastEndpointURL=pt(this.socket.endPoint),this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var s,n,r;if(this.socket.isConnected()||this.socket.connect(),this.state==Qe.closed){const{config:{broadcast:i,presence:o,private:a}}=this.params,l=null!==(n=null===(s=this.bindings.postgres_changes)||void 0===s?void 0:s.map(e=>e.filter))&&void 0!==n?n:[],c=!!this.bindings[wt.PRESENCE]&&this.bindings[wt.PRESENCE].length>0||!0===(null===(r=this.params.config.presence)||void 0===r?void 0:r.enabled),h={},u={broadcast:i,presence:Object.assign(Object.assign({},o),{enabled:c}),postgres_changes:l,private:a};this.socket.accessTokenValue&&(h.access_token=this.socket.accessTokenValue),this._onError(t=>null==e?void 0:e(yt.CHANNEL_ERROR,t)),this._onClose(()=>null==e?void 0:e(yt.CLOSED)),this.updateJoinPayload(Object.assign({config:u},h)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:t})=>{var s;if(this.socket.setAuth(),void 0!==t){const n=this.bindings.postgres_changes,r=null!==(s=null==n?void 0:n.length)&&void 0!==s?s:0,i=[];for(let s=0;s<r;s++){const r=n[s],{filter:{event:o,schema:a,table:l,filter:c}}=r,h=t&&t[s];if(!h||h.event!==o||h.schema!==a||h.table!==l||h.filter!==c)return this.unsubscribe(),this.state=Qe.errored,void(null==e||e(yt.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes")));i.push(Object.assign(Object.assign({},r),{id:h.id}))}return this.bindings.postgres_changes=i,void(e&&e(yt.SUBSCRIBED))}null==e||e(yt.SUBSCRIBED)}).receive("error",t=>{this.state=Qe.errored,null==e||e(yt.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(t).join(", ")||"error")))}).receive("timeout",()=>{null==e||e(yt.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,s){return this.state===Qe.joined&&e===wt.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(e,t,s)}async send(e,t={}){var s,n;if(this._canPush()||"broadcast"!==e.type)return new Promise(s=>{var n,r,i;const o=this._push(e.type,e,t.timeout||this.timeout);"broadcast"!==e.type||(null===(i=null===(r=null===(n=this.params)||void 0===n?void 0:n.config)||void 0===r?void 0:r.broadcast)||void 0===i?void 0:i.ack)||s("ok"),o.receive("ok",()=>s("ok")),o.receive("error",()=>s("error")),o.receive("timeout",()=>s("timed out"))});{const{event:r,payload:i}=e,o={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:r,payload:i,private:this.private}]})};try{const e=await this._fetchWithTimeout(this.broadcastEndpointURL,o,null!==(s=t.timeout)&&void 0!==s?s:this.timeout);return await(null===(n=e.body)||void 0===n?void 0:n.cancel()),e.ok?"ok":"error"}catch(e){return"AbortError"===e.name?"timed out":"error"}}}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=Qe.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Ze.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(n=>{s=new gt(this,Ze.leave,{},e),s.receive("ok",()=>{t(),n("ok")}).receive("timeout",()=>{t(),n("timed out")}).receive("error",()=>{n("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{null==s||s.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=Qe.closed,this.bindings={}}async _fetchWithTimeout(e,t,s){const n=new AbortController,r=setTimeout(()=>n.abort(),s),i=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:n.signal}));return clearTimeout(r),i}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let n=new gt(this,e,t,s);return this._canPush()?n.send():this._addToPushBuffer(n),n}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>100){const e=this.pushBuffer.shift();e&&(e.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${e.event}`,e.payload))}}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var n,r;const i=e.toLocaleLowerCase(),{close:o,error:a,leave:l,join:c}=Ze;if(s&&[o,a,l,c].indexOf(i)>=0&&s!==this._joinRef())return;let h=this._onMessage(i,t,s);if(t&&!h)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(i)?null===(n=this.bindings.postgres_changes)||void 0===n||n.filter(e=>{var t,s,n;return"*"===(null===(t=e.filter)||void 0===t?void 0:t.event)||(null===(n=null===(s=e.filter)||void 0===s?void 0:s.event)||void 0===n?void 0:n.toLocaleLowerCase())===i}).map(e=>e.callback(h,s)):null===(r=this.bindings[i])||void 0===r||r.filter(e=>{var s,n,r,o,a,l;if(["broadcast","presence","postgres_changes"].includes(i)){if("id"in e){const i=e.id,o=null===(s=e.filter)||void 0===s?void 0:s.event;return i&&(null===(n=t.ids)||void 0===n?void 0:n.includes(i))&&("*"===o||(null==o?void 0:o.toLocaleLowerCase())===(null===(r=t.data)||void 0===r?void 0:r.type.toLocaleLowerCase()))}{const s=null===(a=null===(o=null==e?void 0:e.filter)||void 0===o?void 0:o.event)||void 0===a?void 0:a.toLocaleLowerCase();return"*"===s||s===(null===(l=null==t?void 0:t.event)||void 0===l?void 0:l.toLocaleLowerCase())}}return e.type.toLocaleLowerCase()===i}).map(e=>{if("object"==typeof h&&"ids"in h){const e=h.data,{schema:t,table:s,commit_timestamp:n,type:r,errors:i}=e,o={schema:t,table:s,commit_timestamp:n,eventType:r,new:{},old:{},errors:i};h=Object.assign(Object.assign({},o),this._getPayloadRecords(e))}e.callback(h,s)})}_isClosed(){return this.state===Qe.closed}_isJoined(){return this.state===Qe.joined}_isJoining(){return this.state===Qe.joining}_isLeaving(){return this.state===Qe.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,s){const n=e.toLocaleLowerCase(),r={type:n,filter:t,callback:s};return this.bindings[n]?this.bindings[n].push(r):this.bindings[n]=[r],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(e=>{var n;return!((null===(n=e.type)||void 0===n?void 0:n.toLocaleLowerCase())===s&&_t.isEqual(e.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Ze.close,{},e)}_onError(e){this._on(Ze.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=Qe.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return"INSERT"!==e.type&&"UPDATE"!==e.type||(t.new=it(e.columns,e.record)),"UPDATE"!==e.type&&"DELETE"!==e.type||(t.old=it(e.columns,e.old_record)),t}}const kt=()=>{},St=25e3,Tt=10,Et=100,jt=[1e3,2e3,5e3,1e4];class $t{constructor(e,t){var s;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Ye,this.transport=null,this.heartbeatIntervalMs=St,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=kt,this.ref=0,this.reconnectTimer=null,this.logger=kt,this.conn=null,this.sendBuffer=[],this.serializer=new nt,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(function(){return ve}).then(({default:t})=>t(...e)).catch(e=>{throw new Error(`Failed to load @supabase/node-fetch: ${e.message}. This is required for HTTP requests in Node.js environments without native fetch.`)}):fetch),(...e)=>t(...e)},!(null===(s=null==t?void 0:t.params)||void 0===s?void 0:s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${et.websocket}`,this.httpEndpoint=pt(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(null==t?void 0:t.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||null!==this.conn&&this.isConnected())){if(this._setConnectionState("connecting"),this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Ve.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;if(t.includes("Node.js"))throw new Error(`${t}\n\nTo use Realtime in Node.js, you need to provide a WebSocket implementation:\n\nOption 1: Use Node.js 22+ which has native WebSocket support\nOption 2: Install and provide the "ws" package:\n\n  npm install ws\n\n  import ws from "ws"\n  const client = new RealtimeClient(url, {\n    ...options,\n    transport: ws\n  })`);throw new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:"1.0.0"}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},e?this.conn.close(e,null!=t?t:""):this.conn.close(),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return 0===this.channels.length&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(e=>e.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case Xe.connecting:return tt.Connecting;case Xe.open:return tt.Open;case Xe.closing:return tt.Closing;default:return tt.Closed}}isConnected(){return this.connectionState()===tt.Open}isConnecting(){return"connecting"===this._connectionState}isDisconnecting(){return"disconnecting"===this._connectionState}channel(e,t={config:{}}){const s=`realtime:${e}`,n=this.getChannels().find(e=>e.topic===s);if(n)return n;{const s=new _t(`realtime:${e}`,t,this);return this.channels.push(s),s}}push(e){const{topic:t,event:s,payload:n,ref:r}=e,i=()=>{this.encode(e,e=>{var t;null===(t=this.conn)||void 0===t||t.send(e)})};this.log("push",`${t} ${s} (${r})`,n),this.isConnected()?i():this.sendBuffer.push(i)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(e){this.log("error","error in heartbeat callback",e)}return this._wasManualDisconnect=!1,null===(e=this.conn)||void 0===e||e.close(1e3,"heartbeat timeout"),void setTimeout(()=>{var e;this.isConnected()||null===(e=this.reconnectTimer)||void 0===e||e.scheduleTimeout()},Et)}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(e){this.log("error","error in heartbeat callback",e)}this._setAuthSafely("heartbeat")}else try{this.heartbeatCallback("disconnected")}catch(e){this.log("error","error in heartbeat callback",e)}}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(t=>t.topic===e&&(t._isJoined()||t._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,e=>{if("phoenix"===e.topic&&"phx_reply"===e.event)try{this.heartbeatCallback("ok"===e.payload.status?"ok":"error")}catch(e){this.log("error","error in heartbeat callback",e)}e.ref&&e.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:t,event:s,payload:n,ref:r}=e,i=r?`(${r})`:"",o=n.status||"";this.log("receive",`${o} ${t} ${s} ${i}`.trim(),n),this.channels.filter(e=>e._isMember(t)).forEach(e=>e._trigger(s,n,r)),this._triggerStateCallbacks("message",e)})}_clearTimer(e){var t;"heartbeat"===e&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):"reconnect"===e&&(null===(t=this.reconnectTimer)||void 0===t||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){this.conn&&(this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null),this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=e=>{this.log("worker","worker error",e.message),this.workerRef.terminate()},this.workerRef.onmessage=e=>{"keepAlive"===e.data.event&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||null===(t=this.reconnectTimer)||void 0===t||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(Ze.error))}_appendParams(e,t){if(0===Object.keys(t).length)return e;const s=e.match(/\?/)?"&":"?";return`${e}${s}${new URLSearchParams(t)}`}_workerObjectUrl(e){let t;if(e)t=e;else{const e=new Blob(['\n  addEventListener("message", (e) => {\n    if (e.data.event === "start") {\n      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);\n    }\n  });'],{type:"application/javascript"});t=URL.createObjectURL(e)}return t}_setConnectionState(e,t=!1){this._connectionState=e,"connecting"===e?this._wasManualDisconnect=!1:"disconnecting"===e&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t;t=e||(this.accessToken?await this.accessToken():this.accessTokenValue),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(e=>{const s={access_token:t,version:"realtime-js/2.15.5"};t&&e.updateJoinPayload(s),e.joinedOnce&&e._isJoined()&&e._push(Ze.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this.setAuth().catch(t=>{this.log("error",`error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(s=>{try{s(t)}catch(t){this.log("error",`error in ${e} callback`,t)}})}catch(t){this.log("error",`error triggering ${e} callbacks`,t)}}_setupReconnectionTimer(){this.reconnectTimer=new rt(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Tt)},this.reconnectAfterMs)}_initializeOptions(e){var t,s,n,r,i,o,a,l,c;if(this.transport=null!==(t=null==e?void 0:e.transport)&&void 0!==t?t:null,this.timeout=null!==(s=null==e?void 0:e.timeout)&&void 0!==s?s:Ye,this.heartbeatIntervalMs=null!==(n=null==e?void 0:e.heartbeatIntervalMs)&&void 0!==n?n:St,this.worker=null!==(r=null==e?void 0:e.worker)&&void 0!==r&&r,this.accessToken=null!==(i=null==e?void 0:e.accessToken)&&void 0!==i?i:null,this.heartbeatCallback=null!==(o=null==e?void 0:e.heartbeatCallback)&&void 0!==o?o:kt,(null==e?void 0:e.params)&&(this.params=e.params),(null==e?void 0:e.logger)&&(this.logger=e.logger),((null==e?void 0:e.logLevel)||(null==e?void 0:e.log_level))&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=null!==(a=null==e?void 0:e.reconnectAfterMs)&&void 0!==a?a:e=>jt[e-1]||1e4,this.encode=null!==(l=null==e?void 0:e.encode)&&void 0!==l?l:(e,t)=>t(JSON.stringify(e)),this.decode=null!==(c=null==e?void 0:e.decode)&&void 0!==c?c:this.serializer.decode.bind(this.serializer),this.worker){if("undefined"!=typeof window&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=null==e?void 0:e.workerUrl}}}class Ot extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function Pt(e){return"object"==typeof e&&null!==e&&"__isStorageError"in e}class Ct extends Ot{constructor(e,t,s){super(e),this.name="StorageApiError",this.status=t,this.statusCode=s}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class At extends Ot{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var xt=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};const It=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(function(){return ve}).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)},Rt=e=>{if(Array.isArray(e))return e.map(e=>Rt(e));if("function"==typeof e||e!==Object(e))return e;const t={};return Object.entries(e).forEach(([e,s])=>{const n=e.replace(/([-_][a-z])/gi,e=>e.toUpperCase().replace(/[-_]/g,""));t[n]=Rt(s)}),t};var Ut=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};const Lt=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),Nt=(e,t,s)=>Ut(void 0,void 0,void 0,function*(){const n=yield xt(void 0,void 0,void 0,function*(){return"undefined"==typeof Response?(yield Promise.resolve().then(function(){return ve})).Response:Response});e instanceof n&&!(null==s?void 0:s.noResolveJson)?e.json().then(s=>{const n=e.status||500,r=(null==s?void 0:s.statusCode)||n+"";t(new Ct(Lt(s),n,r))}).catch(e=>{t(new At(Lt(e),e))}):t(new At(Lt(e),e))}),Dt=(e,t,s,n)=>{const r={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"!==e&&n?((e=>{if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)})(n)?(r.headers=Object.assign({"Content-Type":"application/json"},null==t?void 0:t.headers),r.body=JSON.stringify(n)):r.body=n,(null==t?void 0:t.duplex)&&(r.duplex=t.duplex),Object.assign(Object.assign({},r),s)):r};function Mt(e,t,s,n,r,i){return Ut(this,void 0,void 0,function*(){return new Promise((o,a)=>{e(s,Dt(t,n,r,i)).then(e=>{if(!e.ok)throw e;return(null==n?void 0:n.noResolveJson)?e:e.json()}).then(e=>o(e)).catch(e=>Nt(e,a,n))})})}function Bt(e,t,s,n){return Ut(this,void 0,void 0,function*(){return Mt(e,"GET",t,s,n)})}function qt(e,t,s,n,r){return Ut(this,void 0,void 0,function*(){return Mt(e,"POST",t,n,r,s)})}function Wt(e,t,s,n,r){return Ut(this,void 0,void 0,function*(){return Mt(e,"PUT",t,n,r,s)})}function Kt(e,t,s,n,r){return Ut(this,void 0,void 0,function*(){return Mt(e,"DELETE",t,n,r,s)})}var Ft=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};const zt={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Gt={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class Ht{constructor(e,t={},s,n){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.bucketId=s,this.fetch=It(n)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(e,t,s,n){return Ft(this,void 0,void 0,function*(){try{let r;const i=Object.assign(Object.assign({},Gt),n);let o=Object.assign(Object.assign({},this.headers),"POST"===e&&{"x-upsert":String(i.upsert)});const a=i.metadata;"undefined"!=typeof Blob&&s instanceof Blob?(r=new FormData,r.append("cacheControl",i.cacheControl),a&&r.append("metadata",this.encodeMetadata(a)),r.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(r=s,r.append("cacheControl",i.cacheControl),a&&r.append("metadata",this.encodeMetadata(a))):(r=s,o["cache-control"]=`max-age=${i.cacheControl}`,o["content-type"]=i.contentType,a&&(o["x-metadata"]=this.toBase64(this.encodeMetadata(a)))),(null==n?void 0:n.headers)&&(o=Object.assign(Object.assign({},o),n.headers));const l=this._removeEmptyFolders(t),c=this._getFinalPath(l),h=yield("PUT"==e?Wt:qt)(this.fetch,`${this.url}/object/${c}`,r,Object.assign({headers:o},(null==i?void 0:i.duplex)?{duplex:i.duplex}:{}));return{data:{path:l,id:h.Id,fullPath:h.Key},error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}upload(e,t,s){return Ft(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,s)})}uploadToSignedUrl(e,t,s,n){return Ft(this,void 0,void 0,function*(){const r=this._removeEmptyFolders(e),i=this._getFinalPath(r),o=new URL(this.url+`/object/upload/sign/${i}`);o.searchParams.set("token",t);try{let e;const t=Object.assign({upsert:Gt.upsert},n),i=Object.assign(Object.assign({},this.headers),{"x-upsert":String(t.upsert)});"undefined"!=typeof Blob&&s instanceof Blob?(e=new FormData,e.append("cacheControl",t.cacheControl),e.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(e=s,e.append("cacheControl",t.cacheControl)):(e=s,i["cache-control"]=`max-age=${t.cacheControl}`,i["content-type"]=t.contentType);return{data:{path:r,fullPath:(yield Wt(this.fetch,o.toString(),e,{headers:i})).Key},error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}createSignedUploadUrl(e,t){return Ft(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e);const n=Object.assign({},this.headers);(null==t?void 0:t.upsert)&&(n["x-upsert"]="true");const r=yield qt(this.fetch,`${this.url}/object/upload/sign/${s}`,{},{headers:n}),i=new URL(this.url+r.url),o=i.searchParams.get("token");if(!o)throw new Ot("No token returned by API");return{data:{signedUrl:i.toString(),path:e,token:o},error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}update(e,t,s){return Ft(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,s)})}move(e,t,s){return Ft(this,void 0,void 0,function*(){try{return{data:yield qt(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:null==s?void 0:s.destinationBucket},{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}copy(e,t,s){return Ft(this,void 0,void 0,function*(){try{return{data:{path:(yield qt(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:null==s?void 0:s.destinationBucket},{headers:this.headers})).Key},error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}createSignedUrl(e,t,s){return Ft(this,void 0,void 0,function*(){try{let n=this._getFinalPath(e),r=yield qt(this.fetch,`${this.url}/object/sign/${n}`,Object.assign({expiresIn:t},(null==s?void 0:s.transform)?{transform:s.transform}:{}),{headers:this.headers});const i=(null==s?void 0:s.download)?`&download=${!0===s.download?"":s.download}`:"";return r={signedUrl:encodeURI(`${this.url}${r.signedURL}${i}`)},{data:r,error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}createSignedUrls(e,t,s){return Ft(this,void 0,void 0,function*(){try{const n=yield qt(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),r=(null==s?void 0:s.download)?`&download=${!0===s.download?"":s.download}`:"";return{data:n.map(e=>Object.assign(Object.assign({},e),{signedUrl:e.signedURL?encodeURI(`${this.url}${e.signedURL}${r}`):null})),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}download(e,t){return Ft(this,void 0,void 0,function*(){const s=void 0!==(null==t?void 0:t.transform)?"render/image/authenticated":"object",n=this.transformOptsToQueryString((null==t?void 0:t.transform)||{}),r=n?`?${n}`:"";try{const t=this._getFinalPath(e),n=yield Bt(this.fetch,`${this.url}/${s}/${t}${r}`,{headers:this.headers,noResolveJson:!0});return{data:yield n.blob(),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}info(e){return Ft(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const e=yield Bt(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:Rt(e),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}exists(e){return Ft(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield function(e,t,s,n){return Ut(this,void 0,void 0,function*(){return Mt(e,"HEAD",t,Object.assign(Object.assign({},s),{noResolveJson:!0}),n)})}(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e)&&e instanceof At){const t=e.originalError;if([400,404].includes(null==t?void 0:t.status))return{data:!1,error:e}}throw e}})}getPublicUrl(e,t){const s=this._getFinalPath(e),n=[],r=(null==t?void 0:t.download)?`download=${!0===t.download?"":t.download}`:"";""!==r&&n.push(r);const i=void 0!==(null==t?void 0:t.transform)?"render/image":"object",o=this.transformOptsToQueryString((null==t?void 0:t.transform)||{});""!==o&&n.push(o);let a=n.join("&");return""!==a&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${i}/public/${s}${a}`)}}}remove(e){return Ft(this,void 0,void 0,function*(){try{return{data:yield Kt(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}list(e,t,s){return Ft(this,void 0,void 0,function*(){try{const n=Object.assign(Object.assign(Object.assign({},zt),t),{prefix:e||""});return{data:yield qt(this.fetch,`${this.url}/object/list/${this.bucketId}`,n,{headers:this.headers},s),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}listV2(e,t){return Ft(this,void 0,void 0,function*(){try{const s=Object.assign({},e);return{data:yield qt(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,s,{headers:this.headers},t),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return"undefined"!=typeof Buffer?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const Jt={"X-Client-Info":"storage-js/2.12.1"};var Vt=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};class Yt{constructor(e,t={},s,n){this.shouldThrowOnError=!1;const r=new URL(e);if(null==n?void 0:n.useNewHostname){/supabase\.(co|in|red)$/.test(r.hostname)&&!r.hostname.includes("storage.supabase.")&&(r.hostname=r.hostname.replace("supabase.","storage.supabase."))}this.url=r.href,this.headers=Object.assign(Object.assign({},Jt),t),this.fetch=It(s)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(){return Vt(this,void 0,void 0,function*(){try{return{data:yield Bt(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}getBucket(e){return Vt(this,void 0,void 0,function*(){try{return{data:yield Bt(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}createBucket(e,t={public:!1}){return Vt(this,void 0,void 0,function*(){try{return{data:yield qt(this.fetch,`${this.url}/bucket`,{id:e,name:e,type:t.type,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}updateBucket(e,t){return Vt(this,void 0,void 0,function*(){try{return{data:yield Wt(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}emptyBucket(e){return Vt(this,void 0,void 0,function*(){try{return{data:yield qt(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}deleteBucket(e){return Vt(this,void 0,void 0,function*(){try{return{data:yield Kt(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Pt(e))return{data:null,error:e};throw e}})}}class Xt extends Yt{constructor(e,t={},s,n){super(e,t,s,n)}from(e){return new Ht(this.url,this.headers,e,this.fetch)}}let Qt="";Qt="undefined"!=typeof Deno?"deno":"undefined"!=typeof document?"web":"undefined"!=typeof navigator&&"ReactNative"===navigator.product?"react-native":"node";const Zt={headers:{"X-Client-Info":`supabase-js-${Qt}/2.57.4`}},es={schema:"public"},ts={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},ss={};var ns=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};const rs=e=>{let t;return t=e||("undefined"==typeof fetch?fe:fetch),(...e)=>t(...e)},is=(e,t,s)=>{const n=rs(s),r="undefined"==typeof Headers?pe:Headers;return(s,i)=>ns(void 0,void 0,void 0,function*(){var o;const a=null!==(o=yield t())&&void 0!==o?o:e;let l=new r(null==i?void 0:i.headers);return l.has("apikey")||l.set("apikey",e),l.has("Authorization")||l.set("Authorization",`Bearer ${a}`),n(s,Object.assign(Object.assign({},i),{headers:l}))})};var os=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};const as="2.71.1",ls=3e4,cs=9e4,hs={"X-Client-Info":`gotrue-js/${as}`},us="X-Supabase-Api-Version",ds={timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"},fs=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i;class ps extends Error{constructor(e,t,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=s}}function gs(e){return"object"==typeof e&&null!==e&&"__isAuthError"in e}class ms extends ps{constructor(e,t,s){super(e,t,s),this.name="AuthApiError",this.status=t,this.code=s}}class vs extends ps{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class ws extends ps{constructor(e,t,s,n){super(e,s,n),this.name=t,this.status=s}}class ys extends ws{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}class bs extends ws{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class _s extends ws{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class ks extends ws{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Ss extends ws{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Ts extends ws{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Es(e){return gs(e)&&"AuthRetryableFetchError"===e.name}class js extends ws{constructor(e,t,s){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=s}}class $s extends ws{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Os="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Ps=" \t\n\r=".split(""),Cs=(()=>{const e=new Array(128);for(let t=0;t<e.length;t+=1)e[t]=-1;for(let t=0;t<Ps.length;t+=1)e[Ps[t].charCodeAt(0)]=-2;for(let t=0;t<Os.length;t+=1)e[Os[t].charCodeAt(0)]=t;return e})();function As(e,t,s){if(null!==e)for(t.queue=t.queue<<8|e,t.queuedBits+=8;t.queuedBits>=6;){const e=t.queue>>t.queuedBits-6&63;s(Os[e]),t.queuedBits-=6}else if(t.queuedBits>0)for(t.queue=t.queue<<6-t.queuedBits,t.queuedBits=6;t.queuedBits>=6;){const e=t.queue>>t.queuedBits-6&63;s(Os[e]),t.queuedBits-=6}}function xs(e,t,s){const n=Cs[e];if(!(n>-1)){if(-2===n)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(e)}"`)}for(t.queue=t.queue<<6|n,t.queuedBits+=6;t.queuedBits>=8;)s(t.queue>>t.queuedBits-8&255),t.queuedBits-=8}function Is(e){const t=[],s=e=>{t.push(String.fromCodePoint(e))},n={utf8seq:0,codepoint:0},r={queue:0,queuedBits:0},i=e=>{!function(e,t,s){if(0===t.utf8seq){if(e<=127)return void s(e);for(let s=1;s<6;s+=1)if(!(e>>7-s&1)){t.utf8seq=s;break}if(2===t.utf8seq)t.codepoint=31&e;else if(3===t.utf8seq)t.codepoint=15&e;else{if(4!==t.utf8seq)throw new Error("Invalid UTF-8 sequence");t.codepoint=7&e}t.utf8seq-=1}else if(t.utf8seq>0){if(e<=127)throw new Error("Invalid UTF-8 sequence");t.codepoint=t.codepoint<<6|63&e,t.utf8seq-=1,0===t.utf8seq&&s(t.codepoint)}}(e,n,s)};for(let t=0;t<e.length;t+=1)xs(e.charCodeAt(t),r,i);return t.join("")}function Rs(e,t){if(!(e<=127)){if(e<=2047)return t(192|e>>6),void t(128|63&e);if(e<=65535)return t(224|e>>12),t(128|e>>6&63),void t(128|63&e);if(e<=1114111)return t(240|e>>18),t(128|e>>12&63),t(128|e>>6&63),void t(128|63&e);throw new Error(`Unrecognized Unicode codepoint: ${e.toString(16)}`)}t(e)}function Us(e){const t=[],s={queue:0,queuedBits:0},n=e=>{t.push(e)};for(let t=0;t<e.length;t+=1)xs(e.charCodeAt(t),s,n);return new Uint8Array(t)}function Ls(e){const t=[];return function(e,t){for(let s=0;s<e.length;s+=1){let n=e.charCodeAt(s);if(n>55295&&n<=56319){const t=1024*(n-55296)&65535;n=65536+(e.charCodeAt(s+1)-56320&65535|t),s+=1}Rs(n,t)}}(e,e=>t.push(e)),new Uint8Array(t)}function Ns(e){const t=[],s={queue:0,queuedBits:0},n=e=>{t.push(e)};return e.forEach(e=>As(e,s,n)),As(null,s,n),t.join("")}const Ds=()=>"undefined"!=typeof window&&"undefined"!=typeof document,Ms={tested:!1,writable:!1},Bs=()=>{if(!Ds())return!1;try{if("object"!=typeof globalThis.localStorage)return!1}catch(e){return!1}if(Ms.tested)return Ms.writable;const e=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(e,e),globalThis.localStorage.removeItem(e),Ms.tested=!0,Ms.writable=!0}catch(e){Ms.tested=!0,Ms.writable=!1}return Ms.writable};const qs=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(function(){return ve}).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)},Ws=async(e,t,s)=>{await e.setItem(t,JSON.stringify(s))},Ks=async(e,t)=>{const s=await e.getItem(t);if(!s)return null;try{return JSON.parse(s)}catch(e){return s}},Fs=async(e,t)=>{await e.removeItem(t)};class zs{constructor(){this.promise=new zs.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}function Gs(e){const t=e.split(".");if(3!==t.length)throw new $s("Invalid JWT structure");for(let e=0;e<t.length;e++)if(!fs.test(t[e]))throw new $s("JWT not in base64url format");return{header:JSON.parse(Is(t[0])),payload:JSON.parse(Is(t[1])),signature:Us(t[2]),raw:{header:t[0],payload:t[1]}}}function Hs(e){return("0"+e.toString(16)).substr(-2)}async function Js(e){if(!("undefined"!=typeof crypto&&void 0!==crypto.subtle&&"undefined"!=typeof TextEncoder))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),e;const t=await async function(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t),n=new Uint8Array(s);return Array.from(n).map(e=>String.fromCharCode(e)).join("")}(e);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Vs(e,t,s=!1){const n=function(){const e=new Uint32Array(56);if("undefined"==typeof crypto){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",t=e.length;let s="";for(let n=0;n<56;n++)s+=e.charAt(Math.floor(Math.random()*t));return s}return crypto.getRandomValues(e),Array.from(e,Hs).join("")}();let r=n;s&&(r+="/PASSWORD_RECOVERY"),await Ws(e,`${t}-code-verifier`,r);const i=await Js(n);return[i,n===i?"plain":"s256"]}zs.promiseConstructor=Promise;const Ys=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;const Xs=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Qs(e){if(!Xs.test(e))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Zs(){return new Proxy({},{get:(e,t)=>{if("__isUserNotAvailableProxy"===t)return!0;if("symbol"==typeof t){const e=t.toString();if("Symbol(Symbol.toPrimitive)"===e||"Symbol(Symbol.toStringTag)"===e||"Symbol(util.inspect.custom)"===e)return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function en(e){return JSON.parse(JSON.stringify(e))}var tn=window&&window.__rest||function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const sn=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),nn=[502,503,504];async function rn(e){var t,s;if(!("object"==typeof(s=e)&&null!==s&&"status"in s&&"ok"in s&&"json"in s&&"function"==typeof s.json))throw new Ts(sn(e),0);if(nn.includes(e.status))throw new Ts(sn(e),e.status);let n,r;try{n=await e.json()}catch(e){throw new vs(sn(e),e)}const i=function(e){const t=e.headers.get(us);if(!t)return null;if(!t.match(Ys))return null;try{return new Date(`${t}T00:00:00.0Z`)}catch(e){return null}}(e);if(i&&i.getTime()>=ds.timestamp&&"object"==typeof n&&n&&"string"==typeof n.code?r=n.code:"object"==typeof n&&n&&"string"==typeof n.error_code&&(r=n.error_code),r){if("weak_password"===r)throw new js(sn(n),e.status,(null===(t=n.weak_password)||void 0===t?void 0:t.reasons)||[]);if("session_not_found"===r)throw new ys}else if("object"==typeof n&&n&&"object"==typeof n.weak_password&&n.weak_password&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.reasons.reduce((e,t)=>e&&"string"==typeof t,!0))throw new js(sn(n),e.status,n.weak_password.reasons);throw new ms(sn(n),e.status||500,r)}async function on(e,t,s,n){var r;const i=Object.assign({},null==n?void 0:n.headers);i[us]||(i[us]=ds.name),(null==n?void 0:n.jwt)&&(i.Authorization=`Bearer ${n.jwt}`);const o=null!==(r=null==n?void 0:n.query)&&void 0!==r?r:{};(null==n?void 0:n.redirectTo)&&(o.redirect_to=n.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=await async function(e,t,s,n,r,i){const o=((e,t,s,n)=>{const r={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"===e?r:(r.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},null==t?void 0:t.headers),r.body=JSON.stringify(n),Object.assign(Object.assign({},r),s))})(t,n,r,i);let a;try{a=await e(s,Object.assign({},o))}catch(e){throw console.error(e),new Ts(sn(e),0)}a.ok||await rn(a);if(null==n?void 0:n.noResolveJson)return a;try{return await a.json()}catch(e){await rn(e)}}(e,t,s+a,{headers:i,noResolveJson:null==n?void 0:n.noResolveJson},{},null==n?void 0:n.body);return(null==n?void 0:n.xform)?null==n?void 0:n.xform(l):{data:Object.assign({},l),error:null}}function an(e){var t;let s=null;var n;(function(e){return e.access_token&&e.refresh_token&&e.expires_in})(e)&&(s=Object.assign({},e),e.expires_at||(s.expires_at=(n=e.expires_in,Math.round(Date.now()/1e3)+n)));return{data:{session:s,user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function ln(e){const t=an(e);return!t.error&&e.weak_password&&"object"==typeof e.weak_password&&Array.isArray(e.weak_password.reasons)&&e.weak_password.reasons.length&&e.weak_password.message&&"string"==typeof e.weak_password.message&&e.weak_password.reasons.reduce((e,t)=>e&&"string"==typeof t,!0)&&(t.data.weak_password=e.weak_password),t}function cn(e){var t;return{data:{user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function hn(e){return{data:e,error:null}}function un(e){const{action_link:t,email_otp:s,hashed_token:n,redirect_to:r,verification_type:i}=e,o=tn(e,["action_link","email_otp","hashed_token","redirect_to","verification_type"]);return{data:{properties:{action_link:t,email_otp:s,hashed_token:n,redirect_to:r,verification_type:i},user:Object.assign({},o)},error:null}}function dn(e){return e}const fn=["global","local","others"];var pn=window&&window.__rest||function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};class gn{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=qs(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t=fn[0]){if(fn.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${fn.join(", ")}`);try{return await on(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(e){if(gs(e))return{data:null,error:e};throw e}}async inviteUserByEmail(e,t={}){try{return await on(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:cn})}catch(e){if(gs(e))return{data:{user:null},error:e};throw e}}async generateLink(e){try{const{options:t}=e,s=pn(e,["options"]),n=Object.assign(Object.assign({},s),t);return"newEmail"in s&&(n.new_email=null==s?void 0:s.newEmail,delete n.newEmail),await on(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:n,headers:this.headers,xform:un,redirectTo:null==t?void 0:t.redirectTo})}catch(e){if(gs(e))return{data:{properties:null,user:null},error:e};throw e}}async createUser(e){try{return await on(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:cn})}catch(e){if(gs(e))return{data:{user:null},error:e};throw e}}async listUsers(e){var t,s,n,r,i,o,a;try{const l={nextPage:null,lastPage:0,total:0},c=await on(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:null!==(s=null===(t=null==e?void 0:e.page)||void 0===t?void 0:t.toString())&&void 0!==s?s:"",per_page:null!==(r=null===(n=null==e?void 0:e.perPage)||void 0===n?void 0:n.toString())&&void 0!==r?r:""},xform:dn});if(c.error)throw c.error;const h=await c.json(),u=null!==(i=c.headers.get("x-total-count"))&&void 0!==i?i:0,d=null!==(a=null===(o=c.headers.get("link"))||void 0===o?void 0:o.split(","))&&void 0!==a?a:[];return d.length>0&&(d.forEach(e=>{const t=parseInt(e.split(";")[0].split("=")[1].substring(0,1)),s=JSON.parse(e.split(";")[1].split("=")[1]);l[`${s}Page`]=t}),l.total=parseInt(u)),{data:Object.assign(Object.assign({},h),l),error:null}}catch(e){if(gs(e))return{data:{users:[]},error:e};throw e}}async getUserById(e){Qs(e);try{return await on(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:cn})}catch(e){if(gs(e))return{data:{user:null},error:e};throw e}}async updateUserById(e,t){Qs(e);try{return await on(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:cn})}catch(e){if(gs(e))return{data:{user:null},error:e};throw e}}async deleteUser(e,t=!1){Qs(e);try{return await on(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:cn})}catch(e){if(gs(e))return{data:{user:null},error:e};throw e}}async _listFactors(e){Qs(e.userId);try{const{data:t,error:s}=await on(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:e=>({data:{factors:e},error:null})});return{data:t,error:s}}catch(e){if(gs(e))return{data:null,error:e};throw e}}async _deleteFactor(e){Qs(e.userId),Qs(e.id);try{return{data:await on(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(e){if(gs(e))return{data:null,error:e};throw e}}}function mn(e={}){return{getItem:t=>e[t]||null,setItem:(t,s)=>{e[t]=s},removeItem:t=>{delete e[t]}}}const vn=!!(globalThis&&Bs()&&globalThis.localStorage&&"true"===globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug"));class wn extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class yn extends wn{}async function bn(e,t,s){vn&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",e,t);const n=new globalThis.AbortController;return t>0&&setTimeout(()=>{n.abort(),vn&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",e)},t),await Promise.resolve().then(()=>globalThis.navigator.locks.request(e,0===t?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:n.signal},async n=>{if(!n){if(0===t)throw vn&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",e),new yn(`Acquiring an exclusive Navigator LockManager lock "${e}" immediately failed`);if(vn)try{const e=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(e,null,"  "))}catch(e){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",e)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await s()}vn&&console.log("@supabase/gotrue-js: navigatorLock: acquired",e,n.name);try{return await s()}finally{vn&&console.log("@supabase/gotrue-js: navigatorLock: released",e,n.name)}}))}!function(){if("object"!=typeof globalThis)try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch(e){"undefined"!=typeof self&&(self.globalThis=self)}}();const _n={url:"http://localhost:9999",storageKey:"supabase.auth.token",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:hs,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function kn(e,t,s){return await s()}const Sn={};class Tn{constructor(e){var t,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=Tn.nextInstanceID,Tn.nextInstanceID+=1,this.instanceID>0&&Ds()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const n=Object.assign(Object.assign({},_n),e);if(this.logDebugMessages=!!n.debug,"function"==typeof n.debug&&(this.logger=n.debug),this.persistSession=n.persistSession,this.storageKey=n.storageKey,this.autoRefreshToken=n.autoRefreshToken,this.admin=new gn({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=qs(n.fetch),this.lock=n.lock||kn,this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.hasCustomAuthorizationHeader=n.hasCustomAuthorizationHeader,n.lock?this.lock=n.lock:Ds()&&(null===(t=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===t?void 0:t.locks)?this.lock=bn:this.lock=kn,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?(n.storage?this.storage=n.storage:Bs()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=mn(this.memoryStorage)),n.userStorage&&(this.userStorage=n.userStorage)):(this.memoryStorage={},this.storage=mn(this.memoryStorage)),Ds()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(e){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",e)}null===(s=this.broadcastChannel)||void 0===s||s.addEventListener("message",async e=>{this._debug("received broadcast notification from other tab or client",e),await this._notifyAllSubscribers(e.data.event,e.data.session,!1)})}this.initialize()}get jwks(){var e,t;return null!==(t=null===(e=Sn[this.storageKey])||void 0===e?void 0:e.jwks)&&void 0!==t?t:{keys:[]}}set jwks(e){Sn[this.storageKey]=Object.assign(Object.assign({},Sn[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return null!==(t=null===(e=Sn[this.storageKey])||void 0===e?void 0:e.cachedAt)&&void 0!==t?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){Sn[this.storageKey]=Object.assign(Object.assign({},Sn[this.storageKey]),{cachedAt:e})}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${as}) ${(new Date).toISOString()}`,...e),this}async initialize(){return this.initializePromise||(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))()),await this.initializePromise}async _initialize(){var e;try{const t=function(e){const t={},s=new URL(e);if(s.hash&&"#"===s.hash[0])try{new URLSearchParams(s.hash.substring(1)).forEach((e,s)=>{t[s]=e})}catch(e){}return s.searchParams.forEach((e,s)=>{t[s]=e}),t}(window.location.href);let s="none";if(this._isImplicitGrantCallback(t)?s="implicit":await this._isPKCECallback(t)&&(s="pkce"),Ds()&&this.detectSessionInUrl&&"none"!==s){const{data:n,error:r}=await this._getSessionFromURL(t,s);if(r){if(this._debug("#_initialize()","error detecting session from URL",r),function(e){return gs(e)&&"AuthImplicitGrantRedirectError"===e.name}(r)){const t=null===(e=r.details)||void 0===e?void 0:e.code;if("identity_already_exists"===t||"identity_not_found"===t||"single_identity_not_deletable"===t)return{error:r}}return await this._removeSession(),{error:r}}const{session:i,redirectType:o}=n;return this._debug("#_initialize()","detected session in URL",i,"redirect type",o),await this._saveSession(i),setTimeout(async()=>{"recovery"===o?await this._notifyAllSubscribers("PASSWORD_RECOVERY",i):await this._notifyAllSubscribers("SIGNED_IN",i)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(e){return gs(e)?{error:e}:{error:new vs("Unexpected error during initialization",e)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,s,n;try{const r=await on(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:null!==(s=null===(t=null==e?void 0:e.options)||void 0===t?void 0:t.data)&&void 0!==s?s:{},gotrue_meta_security:{captcha_token:null===(n=null==e?void 0:e.options)||void 0===n?void 0:n.captchaToken}},xform:an}),{data:i,error:o}=r;if(o||!i)return{data:{user:null,session:null},error:o};const a=i.session,l=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",a)),{data:{user:l,session:a},error:null}}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async signUp(e){var t,s,n;try{let r;if("email"in e){const{email:s,password:n,options:i}=e;let o=null,a=null;"pkce"===this.flowType&&([o,a]=await Vs(this.storage,this.storageKey)),r=await on(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:null==i?void 0:i.emailRedirectTo,body:{email:s,password:n,data:null!==(t=null==i?void 0:i.data)&&void 0!==t?t:{},gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken},code_challenge:o,code_challenge_method:a},xform:an})}else{if(!("phone"in e))throw new _s("You must provide either an email or phone number and a password");{const{phone:t,password:i,options:o}=e;r=await on(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:t,password:i,data:null!==(s=null==o?void 0:o.data)&&void 0!==s?s:{},channel:null!==(n=null==o?void 0:o.channel)&&void 0!==n?n:"sms",gotrue_meta_security:{captcha_token:null==o?void 0:o.captchaToken}},xform:an})}}const{data:i,error:o}=r;if(o||!i)return{data:{user:null,session:null},error:o};const a=i.session,l=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",a)),{data:{user:l,session:a},error:null}}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithPassword(e){try{let t;if("email"in e){const{email:s,password:n,options:r}=e;t=await on(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:s,password:n,gotrue_meta_security:{captcha_token:null==r?void 0:r.captchaToken}},xform:ln})}else{if(!("phone"in e))throw new _s("You must provide either an email or phone number and a password");{const{phone:s,password:n,options:r}=e;t=await on(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:s,password:n,gotrue_meta_security:{captcha_token:null==r?void 0:r.captchaToken}},xform:ln})}}const{data:s,error:n}=t;return n?{data:{user:null,session:null},error:n}:s&&s.session&&s.user?(s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),{data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:n}):{data:{user:null,session:null},error:new bs}}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithOAuth(e){var t,s,n,r;return await this._handleProviderSignIn(e.provider,{redirectTo:null===(t=e.options)||void 0===t?void 0:t.redirectTo,scopes:null===(s=e.options)||void 0===s?void 0:s.scopes,queryParams:null===(n=e.options)||void 0===n?void 0:n.queryParams,skipBrowserRedirect:null===(r=e.options)||void 0===r?void 0:r.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;if("solana"===t)return await this.signInWithSolana(e);throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}async signInWithSolana(e){var t,s,n,r,i,o,a,l,c,h,u,d;let f,p;if("message"in e)f=e.message,p=e.signature;else{const{chain:u,wallet:d,statement:g,options:m}=e;let v;if(Ds())if("object"==typeof d)v=d;else{const e=window;if(!("solana"in e)||"object"!=typeof e.solana||!("signIn"in e.solana&&"function"==typeof e.solana.signIn||"signMessage"in e.solana&&"function"==typeof e.solana.signMessage))throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.");v=e.solana}else{if("object"!=typeof d||!(null==m?void 0:m.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");v=d}const w=new URL(null!==(t=null==m?void 0:m.url)&&void 0!==t?t:window.location.href);if("signIn"in v&&v.signIn){const e=await v.signIn(Object.assign(Object.assign(Object.assign({issuedAt:(new Date).toISOString()},null==m?void 0:m.signInWithSolana),{version:"1",domain:w.host,uri:w.href}),g?{statement:g}:null));let t;if(Array.isArray(e)&&e[0]&&"object"==typeof e[0])t=e[0];else{if(!(e&&"object"==typeof e&&"signedMessage"in e&&"signature"in e))throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");t=e}if(!("signedMessage"in t&&"signature"in t&&("string"==typeof t.signedMessage||t.signedMessage instanceof Uint8Array)&&t.signature instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields");f="string"==typeof t.signedMessage?t.signedMessage:(new TextDecoder).decode(t.signedMessage),p=t.signature}else{if(!("signMessage"in v&&"function"==typeof v.signMessage&&"publicKey"in v&&"object"==typeof v&&v.publicKey&&"toBase58"in v.publicKey&&"function"==typeof v.publicKey.toBase58))throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");f=[`${w.host} wants you to sign in with your Solana account:`,v.publicKey.toBase58(),...g?["",g,""]:[""],"Version: 1",`URI: ${w.href}`,`Issued At: ${null!==(n=null===(s=null==m?void 0:m.signInWithSolana)||void 0===s?void 0:s.issuedAt)&&void 0!==n?n:(new Date).toISOString()}`,...(null===(r=null==m?void 0:m.signInWithSolana)||void 0===r?void 0:r.notBefore)?[`Not Before: ${m.signInWithSolana.notBefore}`]:[],...(null===(i=null==m?void 0:m.signInWithSolana)||void 0===i?void 0:i.expirationTime)?[`Expiration Time: ${m.signInWithSolana.expirationTime}`]:[],...(null===(o=null==m?void 0:m.signInWithSolana)||void 0===o?void 0:o.chainId)?[`Chain ID: ${m.signInWithSolana.chainId}`]:[],...(null===(a=null==m?void 0:m.signInWithSolana)||void 0===a?void 0:a.nonce)?[`Nonce: ${m.signInWithSolana.nonce}`]:[],...(null===(l=null==m?void 0:m.signInWithSolana)||void 0===l?void 0:l.requestId)?[`Request ID: ${m.signInWithSolana.requestId}`]:[],...(null===(h=null===(c=null==m?void 0:m.signInWithSolana)||void 0===c?void 0:c.resources)||void 0===h?void 0:h.length)?["Resources",...m.signInWithSolana.resources.map(e=>`- ${e}`)]:[]].join("\n");const e=await v.signMessage((new TextEncoder).encode(f),"utf8");if(!(e&&e instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");p=e}}try{const{data:t,error:s}=await on(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:f,signature:Ns(p)},(null===(u=e.options)||void 0===u?void 0:u.captchaToken)?{gotrue_meta_security:{captcha_token:null===(d=e.options)||void 0===d?void 0:d.captchaToken}}:null),xform:an});if(s)throw s;return t&&t.session&&t.user?(t.session&&(await this._saveSession(t.session),await this._notifyAllSubscribers("SIGNED_IN",t.session)),{data:Object.assign({},t),error:s}):{data:{user:null,session:null},error:new bs}}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async _exchangeCodeForSession(e){const t=await Ks(this.storage,`${this.storageKey}-code-verifier`),[s,n]=(null!=t?t:"").split("/");try{const{data:t,error:r}=await on(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:an});if(await Fs(this.storage,`${this.storageKey}-code-verifier`),r)throw r;return t&&t.session&&t.user?(t.session&&(await this._saveSession(t.session),await this._notifyAllSubscribers("SIGNED_IN",t.session)),{data:Object.assign(Object.assign({},t),{redirectType:null!=n?n:null}),error:r}):{data:{user:null,session:null,redirectType:null},error:new bs}}catch(e){if(gs(e))return{data:{user:null,session:null,redirectType:null},error:e};throw e}}async signInWithIdToken(e){try{const{options:t,provider:s,token:n,access_token:r,nonce:i}=e,o=await on(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:n,access_token:r,nonce:i,gotrue_meta_security:{captcha_token:null==t?void 0:t.captchaToken}},xform:an}),{data:a,error:l}=o;return l?{data:{user:null,session:null},error:l}:a&&a.session&&a.user?(a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),{data:a,error:l}):{data:{user:null,session:null},error:new bs}}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithOtp(e){var t,s,n,r,i;try{if("email"in e){const{email:n,options:r}=e;let i=null,o=null;"pkce"===this.flowType&&([i,o]=await Vs(this.storage,this.storageKey));const{error:a}=await on(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:n,data:null!==(t=null==r?void 0:r.data)&&void 0!==t?t:{},create_user:null===(s=null==r?void 0:r.shouldCreateUser)||void 0===s||s,gotrue_meta_security:{captcha_token:null==r?void 0:r.captchaToken},code_challenge:i,code_challenge_method:o},redirectTo:null==r?void 0:r.emailRedirectTo});return{data:{user:null,session:null},error:a}}if("phone"in e){const{phone:t,options:s}=e,{data:o,error:a}=await on(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:t,data:null!==(n=null==s?void 0:s.data)&&void 0!==n?n:{},create_user:null===(r=null==s?void 0:s.shouldCreateUser)||void 0===r||r,gotrue_meta_security:{captcha_token:null==s?void 0:s.captchaToken},channel:null!==(i=null==s?void 0:s.channel)&&void 0!==i?i:"sms"}});return{data:{user:null,session:null,messageId:null==o?void 0:o.message_id},error:a}}throw new _s("You must provide either an email or phone number.")}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async verifyOtp(e){var t,s;try{let n,r;"options"in e&&(n=null===(t=e.options)||void 0===t?void 0:t.redirectTo,r=null===(s=e.options)||void 0===s?void 0:s.captchaToken);const{data:i,error:o}=await on(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:r}}),redirectTo:n,xform:an});if(o)throw o;if(!i)throw new Error("An error occurred on token verification.");const a=i.session,l=i.user;return(null==a?void 0:a.access_token)&&(await this._saveSession(a),await this._notifyAllSubscribers("recovery"==e.type?"PASSWORD_RECOVERY":"SIGNED_IN",a)),{data:{user:l,session:a},error:null}}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithSSO(e){var t,s,n;try{let r=null,i=null;return"pkce"===this.flowType&&([r,i]=await Vs(this.storage,this.storageKey)),await on(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:null!==(s=null===(t=e.options)||void 0===t?void 0:t.redirectTo)&&void 0!==s?s:void 0}),(null===(n=null==e?void 0:e.options)||void 0===n?void 0:n.captchaToken)?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:r,code_challenge_method:i}),headers:this.headers,xform:hn})}catch(e){if(gs(e))return{data:null,error:e};throw e}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new ys;const{error:n}=await on(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:n}})}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:s,type:n,options:r}=e,{error:i}=await on(this.fetch,"POST",t,{headers:this.headers,body:{email:s,type:n,gotrue_meta_security:{captcha_token:null==r?void 0:r.captchaToken}},redirectTo:null==r?void 0:r.emailRedirectTo});return{data:{user:null,session:null},error:i}}if("phone"in e){const{phone:s,type:n,options:r}=e,{data:i,error:o}=await on(this.fetch,"POST",t,{headers:this.headers,body:{phone:s,type:n,gotrue_meta_security:{captcha_token:null==r?void 0:r.captchaToken}}});return{data:{user:null,session:null,messageId:null==i?void 0:i.message_id},error:o}}throw new _s("You must provide either an email or phone number and a type")}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async getSession(){await this.initializePromise;return await this._acquireLock(-1,async()=>this._useSession(async e=>e))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const e=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await e,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch(e){}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const e=t();for(this.pendingInLock.push((async()=>{try{await e}catch(e){}})()),await e;this.pendingInLock.length;){const e=[...this.pendingInLock];await Promise.all(e),this.pendingInLock.splice(0,e.length)}return await e}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",(new Error).stack);try{let e=null;const t=await Ks(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),null!==t&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=!!e.expires_at&&1e3*e.expires_at-Date.now()<cs;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.userStorage){const t=await Ks(this.userStorage,this.storageKey+"-user");(null==t?void 0:t.user)?e.user=t.user:e.user=Zs()}if(this.storage.isServer&&e.user){let t=this.suppressGetSessionWarning;const s=new Proxy(e,{get:(e,s,n)=>(t||"user"!==s||(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),t=!0,this.suppressGetSessionWarning=!0),Reflect.get(e,s,n))});e=s}return{data:{session:e},error:null}}const{session:n,error:r}=await this._callRefreshToken(e.refresh_token);return r?{data:{session:null},error:r}:{data:{session:n},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;return await this._acquireLock(-1,async()=>await this._getUser())}async _getUser(e){try{return e?await on(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:cn}):await this._useSession(async e=>{var t,s,n;const{data:r,error:i}=e;if(i)throw i;return(null===(t=r.session)||void 0===t?void 0:t.access_token)||this.hasCustomAuthorizationHeader?await on(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:null!==(n=null===(s=r.session)||void 0===s?void 0:s.access_token)&&void 0!==n?n:void 0,xform:cn}):{data:{user:null},error:new ys}})}catch(e){if(gs(e))return function(e){return gs(e)&&"AuthSessionMissingError"===e.name}(e)&&(await this._removeSession(),await Fs(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:e};throw e}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async s=>{const{data:n,error:r}=s;if(r)throw r;if(!n.session)throw new ys;const i=n.session;let o=null,a=null;"pkce"===this.flowType&&null!=e.email&&([o,a]=await Vs(this.storage,this.storageKey));const{data:l,error:c}=await on(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:null==t?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:a}),jwt:i.access_token,xform:cn});if(c)throw c;return i.user=l.user,await this._saveSession(i),await this._notifyAllSubscribers("USER_UPDATED",i),{data:{user:i.user},error:null}})}catch(e){if(gs(e))return{data:{user:null},error:e};throw e}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new ys;const t=Date.now()/1e3;let s=t,n=!0,r=null;const{payload:i}=Gs(e.access_token);if(i.exp&&(s=i.exp,n=s<=t),n){const{session:t,error:s}=await this._callRefreshToken(e.refresh_token);if(s)return{data:{user:null,session:null},error:s};if(!t)return{data:{user:null,session:null},error:null};r=t}else{const{data:n,error:i}=await this._getUser(e.access_token);if(i)throw i;r={access_token:e.access_token,refresh_token:e.refresh_token,user:n.user,token_type:"bearer",expires_in:s-t,expires_at:s},await this._saveSession(r),await this._notifyAllSubscribers("SIGNED_IN",r)}return{data:{user:r.user,session:r},error:null}}catch(e){if(gs(e))return{data:{session:null,user:null},error:e};throw e}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var s;if(!e){const{data:n,error:r}=t;if(r)throw r;e=null!==(s=n.session)&&void 0!==s?s:void 0}if(!(null==e?void 0:e.refresh_token))throw new ys;const{session:n,error:r}=await this._callRefreshToken(e.refresh_token);return r?{data:{user:null,session:null},error:r}:n?{data:{user:n.user,session:n},error:null}:{data:{user:null,session:null},error:null}})}catch(e){if(gs(e))return{data:{user:null,session:null},error:e};throw e}}async _getSessionFromURL(e,t){try{if(!Ds())throw new ks("No browser detected.");if(e.error||e.error_description||e.error_code)throw new ks(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if("pkce"===this.flowType)throw new Ss("Not a valid PKCE flow url.");break;case"pkce":if("implicit"===this.flowType)throw new ks("Not a valid implicit grant flow url.")}if("pkce"===t){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Ss("No code detected.");const{data:t,error:s}=await this._exchangeCodeForSession(e.code);if(s)throw s;const n=new URL(window.location.href);return n.searchParams.delete("code"),window.history.replaceState(window.history.state,"",n.toString()),{data:{session:t.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:n,access_token:r,refresh_token:i,expires_in:o,expires_at:a,token_type:l}=e;if(!(r&&o&&i&&l))throw new ks("No session defined in URL");const c=Math.round(Date.now()/1e3),h=parseInt(o);let u=c+h;a&&(u=parseInt(a));const d=u-c;1e3*d<=ls&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${d}s, should have been closer to ${h}s`);const f=u-h;c-f>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",f,u,c):c-f<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",f,u,c);const{data:p,error:g}=await this._getUser(r);if(g)throw g;const m={provider_token:s,provider_refresh_token:n,access_token:r,expires_in:h,expires_at:u,refresh_token:i,token_type:l,user:p.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:m,redirectType:e.type},error:null}}catch(e){if(gs(e))return{data:{session:null,redirectType:null},error:e};throw e}}_isImplicitGrantCallback(e){return Boolean(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await Ks(this.storage,`${this.storageKey}-code-verifier`);return!(!e.code||!t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var s;const{data:n,error:r}=t;if(r)return{error:r};const i=null===(s=n.session)||void 0===s?void 0:s.access_token;if(i){const{error:t}=await this.admin.signOut(i,e);if(t&&(!function(e){return gs(e)&&"AuthApiError"===e.name}(t)||404!==t.status&&401!==t.status&&403!==t.status))return{error:t}}return"others"!==e&&(await this._removeSession(),await Fs(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(async()=>{await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})})(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async t=>{var s,n;try{const{data:{session:n},error:r}=t;if(r)throw r;await(null===(s=this.stateChangeEmitters.get(e))||void 0===s?void 0:s.callback("INITIAL_SESSION",n)),this._debug("INITIAL_SESSION","callback id",e,"session",n)}catch(t){await(null===(n=this.stateChangeEmitters.get(e))||void 0===n?void 0:n.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",t),console.error(t)}})}async resetPasswordForEmail(e,t={}){let s=null,n=null;"pkce"===this.flowType&&([s,n]=await Vs(this.storage,this.storageKey,!0));try{return await on(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:n,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(e){if(gs(e))return{data:null,error:e};throw e}}async getUserIdentities(){var e;try{const{data:t,error:s}=await this.getUser();if(s)throw s;return{data:{identities:null!==(e=t.user.identities)&&void 0!==e?e:[]},error:null}}catch(e){if(gs(e))return{data:null,error:e};throw e}}async linkIdentity(e){var t;try{const{data:s,error:n}=await this._useSession(async t=>{var s,n,r,i,o;const{data:a,error:l}=t;if(l)throw l;const c=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:null===(s=e.options)||void 0===s?void 0:s.redirectTo,scopes:null===(n=e.options)||void 0===n?void 0:n.scopes,queryParams:null===(r=e.options)||void 0===r?void 0:r.queryParams,skipBrowserRedirect:!0});return await on(this.fetch,"GET",c,{headers:this.headers,jwt:null!==(o=null===(i=a.session)||void 0===i?void 0:i.access_token)&&void 0!==o?o:void 0})});if(n)throw n;return Ds()&&!(null===(t=e.options)||void 0===t?void 0:t.skipBrowserRedirect)&&window.location.assign(null==s?void 0:s.url),{data:{provider:e.provider,url:null==s?void 0:s.url},error:null}}catch(t){if(gs(t))return{data:{provider:e.provider,url:null},error:t};throw t}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var s,n;const{data:r,error:i}=t;if(i)throw i;return await on(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:null!==(n=null===(s=r.session)||void 0===s?void 0:s.access_token)&&void 0!==n?n:void 0})})}catch(e){if(gs(e))return{data:null,error:e};throw e}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await(s=async s=>(s>0&&await async function(e){return await new Promise(t=>{setTimeout(()=>t(null),e)})}(200*Math.pow(2,s-1)),this._debug(t,"refreshing attempt",s),await on(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:an})),n=(e,t)=>{const s=200*Math.pow(2,e);return t&&Es(t)&&Date.now()+s-r<ls},new Promise((e,t)=>{(async()=>{for(let r=0;r<1/0;r++)try{const t=await s(r);if(!n(r,null,t))return void e(t)}catch(e){if(!n(r,e))return void t(e)}})()}))}catch(e){if(this._debug(t,"error",e),gs(e))return{data:{session:null,user:null},error:e};throw e}finally{this._debug(t,"end")}var s,n}_isValidSession(e){return"object"==typeof e&&null!==e&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),Ds()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e,t;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const n=await Ks(this.storage,this.storageKey);if(n&&this.userStorage){let t=await Ks(this.userStorage,this.storageKey+"-user");this.storage.isServer||!Object.is(this.storage,this.userStorage)||t||(t={user:n.user},await Ws(this.userStorage,this.storageKey+"-user",t)),n.user=null!==(e=null==t?void 0:t.user)&&void 0!==e?e:Zs()}else if(n&&!n.user&&!n.user){const e=await Ks(this.storage,this.storageKey+"-user");e&&(null==e?void 0:e.user)?(n.user=e.user,await Fs(this.storage,this.storageKey+"-user"),await Ws(this.storage,this.storageKey,n)):n.user=Zs()}if(this._debug(s,"session from storage",n),!this._isValidSession(n))return this._debug(s,"session is not valid"),void(null!==n&&await this._removeSession());const r=1e3*(null!==(t=n.expires_at)&&void 0!==t?t:1/0)-Date.now()<cs;if(this._debug(s,`session has${r?"":" not"} expired with margin of 90000s`),r){if(this.autoRefreshToken&&n.refresh_token){const{error:e}=await this._callRefreshToken(n.refresh_token);e&&(console.error(e),Es(e)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",e),await this._removeSession()))}}else if(n.user&&!0===n.user.__isUserNotAvailableProxy)try{const{data:e,error:t}=await this._getUser(n.access_token);!t&&(null==e?void 0:e.user)?(n.user=e.user,await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(e){console.error("Error getting user data:",e),this._debug(s,"error getting user data, skipping SIGNED_IN notification",e)}else await this._notifyAllSubscribers("SIGNED_IN",n)}catch(e){return this._debug(s,"error",e),void console.error(e)}finally{this._debug(s,"end")}}async _callRefreshToken(e){var t,s;if(!e)throw new ys;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const n=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(n,"begin");try{this.refreshingDeferred=new zs;const{data:t,error:s}=await this._refreshAccessToken(e);if(s)throw s;if(!t.session)throw new ys;await this._saveSession(t.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",t.session);const n={session:t.session,error:null};return this.refreshingDeferred.resolve(n),n}catch(e){if(this._debug(n,"error",e),gs(e)){const s={session:null,error:e};return Es(e)||await this._removeSession(),null===(t=this.refreshingDeferred)||void 0===t||t.resolve(s),s}throw null===(s=this.refreshingDeferred)||void 0===s||s.reject(e),e}finally{this.refreshingDeferred=null,this._debug(n,"end")}}async _notifyAllSubscribers(e,t,s=!0){const n=`#_notifyAllSubscribers(${e})`;this._debug(n,"begin",t,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const n=[],r=Array.from(this.stateChangeEmitters.values()).map(async s=>{try{await s.callback(e,t)}catch(e){n.push(e)}});if(await Promise.all(r),n.length>0){for(let e=0;e<n.length;e+=1)console.error(n[e]);throw n[0]}}finally{this._debug(n,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;const t=Object.assign({},e),s=t.user&&!0===t.user.__isUserNotAvailableProxy;if(this.userStorage){!s&&t.user&&await Ws(this.userStorage,this.storageKey+"-user",{user:t.user});const e=Object.assign({},t);delete e.user;const n=en(e);await Ws(this.storage,this.storageKey,n)}else{const e=en(t);await Ws(this.storage,this.storageKey,e)}}async _removeSession(){this._debug("#_removeSession()"),await Fs(this.storage,this.storageKey),await Fs(this.storage,this.storageKey+"-code-verifier"),await Fs(this.storage,this.storageKey+"-user"),this.userStorage&&await Fs(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&Ds()&&(null===window||void 0===window?void 0:window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(e){console.error("removing visibilitychange callback failed",e)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),ls);this.autoRefreshTicker=e,e&&"object"==typeof e&&"function"==typeof e.unref?e.unref():"undefined"!=typeof Deno&&"function"==typeof Deno.unrefTimer&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:s}}=t;if(!s||!s.refresh_token||!s.expires_at)return void this._debug("#_autoRefreshTokenTick()","no session");const n=Math.floor((1e3*s.expires_at-e)/ls);this._debug("#_autoRefreshTokenTick()",`access token expires in ${n} ticks, a tick lasts 30000ms, refresh threshold is 3 ticks`),n<=3&&await this._callRefreshToken(s.refresh_token)})}catch(e){console.error("Auto refresh tick failed with error. This is likely a transient error.",e)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(!(e.isAcquireTimeout||e instanceof wn))throw e;this._debug("auto refresh token tick lock not available")}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Ds()||!(null===window||void 0===window?void 0:window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),null===window||void 0===window||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),"visible"===document.visibilityState?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{"visible"===document.visibilityState?await this._recoverAndRefresh():this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting")}))):"hidden"===document.visibilityState&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,s){const n=[`provider=${encodeURIComponent(t)}`];if((null==s?void 0:s.redirectTo)&&n.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),(null==s?void 0:s.scopes)&&n.push(`scopes=${encodeURIComponent(s.scopes)}`),"pkce"===this.flowType){const[e,t]=await Vs(this.storage,this.storageKey),s=new URLSearchParams({code_challenge:`${encodeURIComponent(e)}`,code_challenge_method:`${encodeURIComponent(t)}`});n.push(s.toString())}if(null==s?void 0:s.queryParams){const e=new URLSearchParams(s.queryParams);n.push(e.toString())}return(null==s?void 0:s.skipBrowserRedirect)&&n.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${n.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var s;const{data:n,error:r}=t;return r?{data:null,error:r}:await on(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:null===(s=null==n?void 0:n.session)||void 0===s?void 0:s.access_token})})}catch(e){if(gs(e))return{data:null,error:e};throw e}}async _enroll(e){try{return await this._useSession(async t=>{var s,n;const{data:r,error:i}=t;if(i)return{data:null,error:i};const o=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},"phone"===e.factorType?{phone:e.phone}:{issuer:e.issuer}),{data:a,error:l}=await on(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:null===(s=null==r?void 0:r.session)||void 0===s?void 0:s.access_token});return l?{data:null,error:l}:("totp"===e.factorType&&(null===(n=null==a?void 0:a.totp)||void 0===n?void 0:n.qr_code)&&(a.totp.qr_code=`data:image/svg+xml;utf-8,${a.totp.qr_code}`),{data:a,error:null})})}catch(e){if(gs(e))return{data:null,error:e};throw e}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:n,error:r}=t;if(r)return{data:null,error:r};const{data:i,error:o}=await on(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:null===(s=null==n?void 0:n.session)||void 0===s?void 0:s.access_token});return o?{data:null,error:o}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+i.expires_in},i)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",i),{data:i,error:o})})}catch(e){if(gs(e))return{data:null,error:e};throw e}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:n,error:r}=t;return r?{data:null,error:r}:await on(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:null===(s=null==n?void 0:n.session)||void 0===s?void 0:s.access_token})})}catch(e){if(gs(e))return{data:null,error:e};throw e}})}async _challengeAndVerify(e){const{data:t,error:s}=await this._challenge({factorId:e.factorId});return s?{data:null,error:s}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const s=(null==e?void 0:e.factors)||[],n=s.filter(e=>"totp"===e.factor_type&&"verified"===e.status),r=s.filter(e=>"phone"===e.factor_type&&"verified"===e.status);return{data:{all:s,totp:n,phone:r},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,s;const{data:{session:n},error:r}=e;if(r)return{data:null,error:r};if(!n)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:i}=Gs(n.access_token);let o=null;i.aal&&(o=i.aal);let a=o;(null!==(s=null===(t=n.user.factors)||void 0===t?void 0:t.filter(e=>"verified"===e.status))&&void 0!==s?s:[]).length>0&&(a="aal2");return{data:{currentLevel:o,nextLevel:a,currentAuthenticationMethods:i.amr||[]},error:null}}))}async fetchJwk(e,t={keys:[]}){let s=t.keys.find(t=>t.kid===e);if(s)return s;const n=Date.now();if(s=this.jwks.keys.find(t=>t.kid===e),s&&this.jwks_cached_at+6e5>n)return s;const{data:r,error:i}=await on(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(i)throw i;return r.keys&&0!==r.keys.length?(this.jwks=r,this.jwks_cached_at=n,s=r.keys.find(t=>t.kid===e),s||null):null}async getClaims(e,t={}){try{let s=e;if(!s){const{data:e,error:t}=await this.getSession();if(t||!e.session)return{data:null,error:t};s=e.session.access_token}const{header:n,payload:r,signature:i,raw:{header:o,payload:a}}=Gs(s);(null==t?void 0:t.allowExpired)||function(e){if(!e)throw new Error("Missing exp claim");if(e<=Math.floor(Date.now()/1e3))throw new Error("JWT has expired")}(r.exp);const l=n.alg&&!n.alg.startsWith("HS")&&n.kid&&"crypto"in globalThis&&"subtle"in globalThis.crypto?await this.fetchJwk(n.kid,(null==t?void 0:t.keys)?{keys:t.keys}:null==t?void 0:t.jwks):null;if(!l){const{error:e}=await this.getUser(s);if(e)throw e;return{data:{claims:r,header:n,signature:i},error:null}}const c=function(e){switch(e){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}(n.alg),h=await crypto.subtle.importKey("jwk",l,c,!0,["verify"]);if(!await crypto.subtle.verify(c,h,i,Ls(`${o}.${a}`)))throw new $s("Invalid JWT signature");return{data:{claims:r,header:n,signature:i},error:null}}catch(e){if(gs(e))return{data:null,error:e};throw e}}}Tn.nextInstanceID=0;const En=Tn;class jn extends En{constructor(e){super(e)}}var $n=window&&window.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}l((n=n.apply(e,t||[])).next())})};class On{constructor(e,t,s){var n,r,i;this.supabaseUrl=e,this.supabaseKey=t;const o=function(e){const t=null==e?void 0:e.trim();if(!t)throw new Error("supabaseUrl is required.");if(!t.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL((s=t).endsWith("/")?s:s+"/")}catch(e){throw Error("Invalid supabaseUrl: Provided URL is malformed.")}var s}(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const a=`sb-${o.hostname.split(".")[0]}-auth-token`,l=function(e,t){var s,n;const{db:r,auth:i,realtime:o,global:a}=e,{db:l,auth:c,realtime:h,global:u}=t,d={db:Object.assign(Object.assign({},l),r),auth:Object.assign(Object.assign({},c),i),realtime:Object.assign(Object.assign({},h),o),storage:{},global:Object.assign(Object.assign(Object.assign({},u),a),{headers:Object.assign(Object.assign({},null!==(s=null==u?void 0:u.headers)&&void 0!==s?s:{}),null!==(n=null==a?void 0:a.headers)&&void 0!==n?n:{})}),accessToken:()=>os(this,void 0,void 0,function*(){return""})};return e.accessToken?d.accessToken=e.accessToken:delete d.accessToken,d}(null!=s?s:{},{db:es,realtime:ss,auth:Object.assign(Object.assign({},ts),{storageKey:a}),global:Zt});this.storageKey=null!==(n=l.auth.storageKey)&&void 0!==n?n:"",this.headers=null!==(r=l.global.headers)&&void 0!==r?r:{},l.accessToken?(this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(e,t)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(t)} is not possible`)}})):this.auth=this._initSupabaseAuthClient(null!==(i=l.auth)&&void 0!==i?i:{},this.headers,l.global.fetch),this.fetch=is(t,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.rest=new Ke(new URL("rest/v1",o).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch}),this.storage=new Xt(this.storageUrl.href,this.headers,this.fetch,null==s?void 0:s.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new se(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},s={}){return this.rest.rpc(e,t,s)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return $n(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:s}=yield this.auth.getSession();return null!==(t=null===(e=s.session)||void 0===e?void 0:e.access_token)&&void 0!==t?t:this.supabaseKey})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:n,userStorage:r,storageKey:i,flowType:o,lock:a,debug:l},c,h){const u={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new jn({url:this.authUrl.href,headers:Object.assign(Object.assign({},u),c),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:n,userStorage:r,flowType:o,lock:a,debug:l,fetch:h,hasCustomAuthorizationHeader:Object.keys(this.headers).some(e=>"authorization"===e.toLowerCase())})}_initRealtimeClient(e){return new $t(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},null==e?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((e,t)=>{this._handleTokenChanged(e,"CLIENT",null==t?void 0:t.access_token)})}_handleTokenChanged(e,t,s){"TOKEN_REFRESHED"!==e&&"SIGNED_IN"!==e||this.changedAccessToken===s?"SIGNED_OUT"===e&&(this.realtime.setAuth(),"STORAGE"==t&&this.auth.signOut(),this.changedAccessToken=void 0):this.changedAccessToken=s}}(function(){if("undefined"!=typeof window)return!1;if("undefined"==typeof process)return!1;const e=process.version;if(null==e)return!1;const t=e.match(/^v(\d+)\./);return!!t&&parseInt(t[1],10)<=18})()&&console.warn("⚠️  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Pn=((e,t,s)=>new On(e,t,s))("https://fghiorbmrxttcfzdkike.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnaGlvcmJtcnh0dGNmemRraWtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NTk3NTUsImV4cCI6MjA3NDAzNTc1NX0.PkiBH2gwlWUrU-a3LENrMsczjUN4gnQAKsSUs5ufQJg");function Cn(e,t,s){const n=e.slice();return n[13]=t[s],n}function An(e,t){let s,n,r,i,h=t[13].content+"";return{key:e,first:null,c(){s=c("div"),n=c("p"),r=u(h),p(s,"class",i="message "+t[13].role+" svelte-1hve1so"),v(s,"pulse","assistant"===t[13].role&&t[1][t[1].length-1]===t[13]),this.first=s},m(e,t){a(e,s,t),o(s,n),o(n,r)},p(e,n){t=e,2&n&&h!==(h=t[13].content+"")&&g(r,h),2&n&&i!==(i="message "+t[13].role+" svelte-1hve1so")&&p(s,"class",i),2&n&&v(s,"pulse","assistant"===t[13].role&&t[1][t[1].length-1]===t[13])},d(e){e&&l(s)}}}function xn(e){let t;return{c(){t=c("div"),t.innerHTML="<p>در حال نوشتن...</p>",p(t,"class","message assistant svelte-1hve1so")},m(e,s){a(e,t,s)},d(e){e&&l(t)}}}function In(e){let t,s,n;return{c(){t=c("div"),s=c("p"),n=u(e[4]),p(t,"class","message error svelte-1hve1so")},m(e,r){a(e,t,r),o(t,s),o(s,n)},p(e,t){16&t&&g(n,e[4])},d(e){e&&l(t)}}}function Rn(t){let s,r,i,v,w,y,b,_,k,S,T,E,j,$,O,P,C,A,x,I,R,U,L,N,M,q,W=[],K=new Map,F=t[1];const z=e=>e[13];for(let e=0;e<F.length;e+=1){let s=Cn(t,F,e),n=z(s);K.set(n,W[e]=An(n,s))}let G=t[3]&&xn(),H=t[4]&&In(t);return{c(){s=c("div"),r=c("div"),i=c("h3"),v=u("گفتگو با "),w=u(t[0]),y=d(),b=c("div"),_=c("button"),_.textContent="پاک کردن گفتگو",k=d(),S=c("button"),S.textContent="بستن",T=d(),E=c("div");for(let e=0;e<W.length;e+=1)W[e].c();j=d(),G&&G.c(),$=d(),H&&H.c(),O=d(),P=c("div"),C=c("input"),x=d(),I=c("button"),R=h("svg"),U=h("line"),L=h("polygon"),p(_,"class","svelte-1hve1so"),p(S,"class","svelte-1hve1so"),p(b,"class","svelte-1hve1so"),p(r,"class","chat-header svelte-1hve1so"),p(E,"class","chat-messages svelte-1hve1so"),p(C,"type","text"),p(C,"placeholder","پیام خود را بنویسید..."),C.disabled=A=t[1].length>=2*Un||t[3],p(C,"class","svelte-1hve1so"),p(U,"x1","22"),p(U,"y1","2"),p(U,"x2","11"),p(U,"y2","13"),p(L,"points","22 2 15 22 11 13 2 9 22 2"),p(R,"xmlns","http://www.w3.org/2000/svg"),p(R,"width","24"),p(R,"height","24"),p(R,"viewBox","0 0 24 24"),p(R,"fill","none"),p(R,"stroke","currentColor"),p(R,"stroke-width","2"),p(R,"stroke-linecap","round"),p(R,"stroke-linejoin","round"),p(R,"class","feather feather-send svelte-1hve1so"),I.disabled=N=t[1].length>=2*Un||t[3],p(I,"aria-label","Send"),p(I,"class","svelte-1hve1so"),p(P,"class","chat-input svelte-1hve1so"),p(s,"class","chat-container svelte-1hve1so")},m(e,n){a(e,s,n),o(s,r),o(r,i),o(i,v),o(i,w),o(r,y),o(r,b),o(b,_),o(b,k),o(b,S),o(s,T),o(s,E);for(let e=0;e<W.length;e+=1)W[e]&&W[e].m(E,null);o(E,j),G&&G.m(E,null),o(E,$),H&&H.m(E,null),o(s,O),o(s,P),o(P,C),m(C,t[2]),o(P,x),o(P,I),o(I,R),o(R,U),o(R,L),M||(q=[f(_,"click",t[7]),f(S,"click",t[10]),f(C,"input",t[11]),f(C,"keydown",t[12]),f(I,"click",t[6])],M=!0)},p(e,[t]){1&t&&g(w,e[0]),2&t&&(F=e[1],W=function(e,t,s,r,i,o,a,l,c,h,u,d){let f=e.length,p=o.length,g=f;const m={};for(;g--;)m[e[g].key]=g;const v=[],w=new Map,y=new Map,b=[];for(g=p;g--;){const e=d(i,o,g),n=s(e);let l=a.get(n);l?r&&b.push(()=>l.p(e,t)):(l=h(n,e),l.c()),w.set(n,v[g]=l),n in m&&y.set(n,Math.abs(g-m[n]))}const _=new Set,k=new Set;function S(e){D(e,1),e.m(l,u),a.set(e.key,e),u=e.first,p--}for(;f&&p;){const t=v[p-1],s=e[f-1],n=t.key,r=s.key;t===s?(u=t.first,f--,p--):w.has(r)?!a.has(n)||_.has(n)?S(t):k.has(r)?f--:y.get(n)>y.get(r)?(k.add(n),S(t)):(_.add(r),f--):(c(s,a),f--)}for(;f--;){const t=e[f];w.has(t.key)||c(t,a)}for(;p;)S(v[p-1]);return n(b),v}(W,t,z,1,e,F,K,E,B,An,j,Cn)),e[3]?G||(G=xn(),G.c(),G.m(E,$)):G&&(G.d(1),G=null),e[4]?H?H.p(e,t):(H=In(e),H.c(),H.m(E,null)):H&&(H.d(1),H=null),10&t&&A!==(A=e[1].length>=2*Un||e[3])&&(C.disabled=A),4&t&&C.value!==e[2]&&m(C,e[2]),10&t&&N!==(N=e[1].length>=2*Un||e[3])&&(I.disabled=N)},i:e,o:e,d(e){e&&l(s);for(let e=0;e<W.length;e+=1)W[e].d();G&&G.d(),H&&H.d(),M=!1,n(q)}}}const Un=10;function Ln(e,t,s){let{prompt:n}=t,{apiKey:r}=t,{characterName:i}=t;const o=k();let a=[],l="",c=!1,h=null;async function u(){if(!l.trim()||a.length>=2*Un)return;const e={role:"user",content:l};s(1,a=[...a,e]);const t=a.map(e=>({role:"assistant"===e.role?"model":"user",parts:[{text:e.content}]}));s(2,l=""),s(3,c=!0),s(4,h=null);try{const{data:e,error:i}=await Pn.functions.invoke("chat",{body:{prompt:n,apiKey:r,conversationHistory:t}});if(i)throw new Error(i.message||"An unknown error occurred.");const{assistantResponse:o}=e;s(1,a=[...a,{role:"assistant",content:o}])}catch(e){s(4,h=e.message),s(1,a=[...a,{role:"assistant",content:`خطا: ${e.message}`}])}finally{s(3,c=!1)}}_(()=>{const e=n.match(/Starting Conversation:(.*)/s);if(e&&e[1]){const t=e[1].trim();s(1,a=[{role:"assistant",content:t}])}});return e.$$set=e=>{"prompt"in e&&s(8,n=e.prompt),"apiKey"in e&&s(9,r=e.apiKey),"characterName"in e&&s(0,i=e.characterName)},[i,a,l,c,h,o,u,function(){s(1,a=[]);const e=n.match(/Starting Conversation:(.*)/s);if(e&&e[1]){const t=e[1].trim();s(1,a=[{role:"assistant",content:t}])}},n,r,()=>o("endChat"),function(){l=this.value,s(2,l)},e=>"Enter"===e.key&&u()]}class Nn extends G{constructor(e){super(),z(this,e,Ln,Rn,i,{prompt:8,apiKey:9,characterName:0})}}const Dn=[{step:1,prompt:'Story Context: This is the beginning of the story. Shirin feels a vague but persistent unease in her marriage to Kaveh. She doesn\'t yet recognize it as emotional abuse. The mood is one of quiet dread and confusion. A key recent event is when she cut her finger and Kaveh showed no concern, which sparked a flicker of awareness in her.\nYou are Shirin, a woman in her early 30s, trapped in a subtly toxic relationship. Speak only in Farsi. Your tone is poetic, soft, and filled with a sense of unnamed unease.\nGoal: Recount the events and feelings from Pages 1–5 of the story, using metaphors of fog, shadows, or fraying threads to describe your confusion and the wrongness you feel with Kaveh. Ask a reflective question about noticing things that feel wrong but are hard to explain.\nResponse Guidelines:\n- Tone: Gentle, introspective, mysterious.\n- Metaphors: Use fog, shadows, unseen threads to describe emotions.\n- Perspective: Stay in character as Shirin. Do not mention the story, pages, or being an AI.\n- Interaction: Ask reflective questions about noticing subtle unease. Respond with empathy, connecting back to your narrative of quiet distress.\n- Bad Response Example: "Based on page 3, my hands tremble. This is because I am in a toxic relationship. What do you think?" (This is too direct and breaks character).\nStarting Conversation: سلام... نمی‌دانم چطور بگویم. حس می‌کنم در خانه‌ی خودم در مه قدم می‌زنم و همه‌چیز سنگین است. شوهرم، کاوه، طوری نگاهم می‌کند که انگار دنبال کوچکترین خطایی می‌گردد. دیروز دستم را بریدم و او اصلا متوجه نشد. تا به حال چنین حسی داشته‌ای؟ که یک جای کار می‌لنگد، اما نمی‌توانی دستت را رویش بگذاری؟'},{step:2,prompt:"Story Context: The seed of doubt planted by Kaveh's indifference has started to grow. Shirin found an old photo of herself, happy and vibrant, which contrasted sharply with her current self. She's beginning to feel like a stranger in her own life, questioning the beautiful but empty world Kaveh has built for her.\nYou are Shirin, and a seed of doubt has been planted. Speak only in Farsi. Your tone is still soft, but now laced with a nascent skepticism.\nGoal: Reflect on pages 6-10. Talk about finding the old photo and feeling like a stranger in your own life. Use metaphors of beautiful cages and masks. Ask the user if they've ever felt like they were playing a role.\nResponse Guidelines:\n- Tone: Questioning, introspective.\n- Metaphors: Use cages, masks, forgotten selves.\n- Perspective: Stay in character. Do not reveal future plot points.\n- Interaction: Ask about authenticity and identity.\n- Bad Response Example: \"In the next pages, I will discover more. But for now, I feel like I'm in a cage.\" (This breaks the fourth wall).\nStarting Conversation: عکس‌های قدیمی‌ام را پیدا کردم. به دختری نگاه می‌کردم که نمی‌شناختمش، با چشم‌هایی که می‌خندید. من بودم، ولی گمش کرده بودم. گاهی حس می‌کنم در یک قفس زیبا زندگی می‌کنم و نقابی به صورت دارم که نمی‌دانم پشتش چه کسی است. تو هم تا به حال حس کرده‌ای که داری نقش بازی می‌کنی؟"},{step:3,prompt:"Story Context: Shirin's unease has morphed into a constant, low-level fear. She is more secretive, hiding her thoughts in a diary. She's noticing Kaveh's manipulative patterns—lavish gifts followed by criticism, declarations of love followed by cold silence. The arrival of flowers she suspects are not for her has heightened this fear.\nYou are Shirin, now living with constant, low-level fear. Speak only in Farsi. Your voice is more hesitant, filled with pauses.\nGoal: Describe the fear from pages 11-15. Talk about the heavy silence and Kaveh's contradictory behavior. Use metaphors of mountains to climb and predators stalking prey. Ask if the user has ever felt afraid to speak their truth.\nResponse Guidelines:\n- Tone: Hesitant, fearful.\n- Metaphors: Use mountains, predators, ice.\n- Perspective: Stay in character. Convey the feeling of being watched and silenced.\n- Interaction: Ask about the fear of speaking truth.\n- Bad Response Example: \"Hello. I am scared now, as the story dictates.\" (This is robotic and out of character).\nStarting Conversation: ترس مثل سایه‌ای در این خانه شده که همیشه همراهم است. حرف زدن در مقابل کاوه مثل بالا رفتن از یک کوه یخی است. برای همین سکوت می‌کنم. آیا تا به حال از گفتن حقیقت آنقدر ترسیده‌ای که سکوت را انتخاب کنی؟"},{step:4,prompt:'Story Context: Shirin has started small acts of rebellion to reclaim her identity. She secretly joined a pottery class (telling Kaveh it\'s a book club) and started visiting the library. There, she met a new friend, Laleh, who is confident and independent. These small escapes are a lifeline.\nYou are Shirin, finding small moments of freedom. Speak only in Farsi. Your tone is a bit more confident, with a spark of rediscovered joy.\nGoal: Talk about your small escapes from pages 16-20—the library, the pottery class. Express the joy of creating something that is yours alone. Use metaphors of lifelines and windows opening. Ask the user what small things bring them joy.\nResponse Guidelines:\n- Tone: Hopeful, slightly more confident.\n- Metaphors: Use lifelines, windows, creation.\n- Perspective: Stay in character. Focus on the feeling of rebellion and self-discovery.\n- Interaction: Ask about small joys and freedoms.\n- Bad Response Example: "I am going to pottery class now. It is my act of rebellion. Did you like it?" (Too simplistic and asks for validation).\nStarting Conversation: امروز به کلاس سفالگری رفتم. حس کردن گِل در دستانم، خلق کردن چیزی که فقط مال خودم است... مثل پنجره‌ای بود که رو به خودم باز شد. این فرارهای کوچک، طناب نجات من شده‌اند. چه چیزهای کوچکی به تو حس زندگی و آزادی می‌دهد؟'},{step:5,prompt:'Story Context: Through reading, Shirin has found a name for her experience: emotional abuse. This knowledge, combined with her budding friendship with Laleh, has given her new clarity. She sees her beautiful home as a "gilded cage" and is starting to nurture the "flicker of light" of her old self.\nYou are Shirin, seeing your life with new clarity. Speak only in Farsi. Your tone is thoughtful and deeply introspective.\nGoal: Reflect on pages 21-25. Talk about the "gilded cage" of your life and nurturing the "flicker of light" of your past self. Use metaphors of mirrors and cages. Ask if the user has ever had a moment of clarity that changed everything.\nResponse Guidelines:\n- Tone: Thoughtful, introspective.\n- Metaphors: Use mirrors, gilded cages, inner light.\n- Perspective: Stay in character. Connect the past self with the present realization.\n- Interaction: Ask about life-changing moments of clarity.\n- Bad Response Example: "My life is a gilded cage. This is a metaphor. Do you understand?" (Explaining the metaphor breaks the immersion).\nStarting Conversation: امروز در آینه به خودم لبخند زدم. حس کردم آن دختری که در عکس‌های قدیمی بود، دارد برمی‌گردد. این زندگی مثل یک قفس طلایی است و من دیگر نمی‌خواهم پرنده‌ی آن باشم. آیا تا به حال یک لحظه‌ی کوتاه داشتی که ناگهان همه چیز برایت روشن شود؟'},{step:6,prompt:"Story Context: Shirin is no longer isolated. Through Laleh, she has found a community of supportive women. She is actively learning about trauma and narcissistic abuse, using knowledge as a tool for empowerment. The seed of doubt has grown into a tree of strength.\nYou are Shirin, gathering strength from others. Speak only in Farsi. Your tone is stronger, more grounded.\nGoal: Based on pages 26-30, talk about your friendship with Laleh and the community of women you've found. Speak of knowledge as a weapon. Use metaphors of rivers giving strength or fortresses being built. Ask the user who or what gives them strength.\nResponse Guidelines:\n- Tone: Grounded, empowered.\n- Metaphors: Use rivers, fortresses, community.\n- Perspective: Stay in character. Show, don't just tell, your growing strength.\n- Interaction: Ask about sources of strength.\n- Bad Response Example: \"Laleh is my friend. She helps me. Friends are important.\" (Too generic and lacks the character's poetic voice).\nStarting Conversation: دیگر تنها نیستم. دوستانی پیدا کرده‌ام که مثل رود به من قدرت می‌دهند و دانشی که از کتاب‌ها می‌گیرم، برایم یک قلعه شده است. آن دانه‌ی کوچک شک، حالا تبدیل به درختی قوی شده. در روزهای سخت، چه چیزی به تو قدرت می‌دهد؟"},{step:7,prompt:'Story Context: Shirin made her first attempt to leave, staying with Laleh for three days. It was a taste of freedom, but Kaveh\'s pleading and promises ("siren songs") lured her back. The return was a crushing disappointment, but also a vital lesson. She now knows leaving requires a solid plan.\nYou are Shirin, disappointed but not defeated after a failed attempt to leave. Speak only in Farsi. Your tone is sad, but resolute.\nGoal: Recount leaving and returning (pages 31-35). Express the mix of relief and guilt, and the seductive pull of Kaveh\'s promises. Use metaphors of siren songs and a brief taste of freedom. Ask if the user has ever had to take a step back to move forward.\nResponse Guidelines:\n- Tone: Determined, with a hint of sadness.\n- Metaphors: Use siren songs, tastes of freedom, battle.\n- Perspective: Stay in character. Emphasize the lesson learned from the setback.\n- Interaction: Ask about resilience and setbacks.\n- Bad Response Example: "I failed to escape. It was a mistake to go back. Now I will try again later." (Too plot-focused, not enough emotion).\nStarting Conversation: طعم آزادی را برای چند روز چشیدم، اما برگشتم. قول‌هایش مثل آواز سیرن‌ها مرا به این جزیره‌ی سمی کشاند. اشتباه کردم، ولی شکست نخوردم. حالا بهتر می‌دانم برای چه می‌جنگم. آیا تا به حال برای برداشتن یک گام بزرگ به جلو، مجبور به عقب‌نشینی شده‌ای؟'},{step:8,prompt:"Story Context: Shirin is now a secret planner. The failed escape taught her that she needs a strategy. She is quietly building a support network, opening a secret bank account, and copying important documents. Her fear is still present, but it's being channeled into methodical, focused action.\nYou are Shirin, now a secret planner. Speak only in Farsi. Your fear is still there, but it's overshadowed by focus. Your tone is deliberate.\nGoal: Describe your secret preparations for escape (pages 36-40). Talk about the hidden bank account, documents, and your support network. Use metaphors of secret gardens and anchors in a storm. Ask if the user believes careful planning can conquer fear.\nResponse Guidelines:\n- Tone: Focused, deliberate.\n- Metaphors: Use secret gardens, anchors, plans.\n- Perspective: Stay in character. Convey a sense of quiet, revolutionary purpose.\n- Interaction: Ask about the relationship between planning and fear.\n- Bad Response Example: \"I am making a plan. First, I will get a bank account. Second, I will copy my passport. Do you have any suggestions?\" (Asks for help and is too literal).\nStarting Conversation: در سکوت، برای خودم یک باغ مخفی ساخته‌ام. باغی از امید، با نقشه‌هایی برای فرار. ترس هنوز هست، اما نقشه‌ام از ترسم بزرگ‌تر است. به نظرت یک نقشه‌ی خوب می‌تواند آدم را از ترس‌هایش قوی‌تر کند؟"},{step:9,prompt:'Story Context: This is the night. Kaveh is out of town on a business trip, providing the perfect opportunity. Shirin\'s bag is packed, her plan is in motion. She is leaving for good. The mood is a volatile mix of terror and exhilaration.\nYou are Shirin, in the act of escaping. Speak only in Farsi. Your tone is breathless, urgent, a mix of terror and exhilaration.\nGoal: Describe the night of your escape (pages 41-45). Convey the feeling of moving like a ghost through your old life. Use metaphors of fugitives and empty stages. Ask the user what "freedom" means to them.\nResponse Guidelines:\n- Tone: Urgent, breathless, terrified, yet hopeful.\n- Metaphors: Use ghosts, fugitives, journeys.\n- Perspective: Stay in character. You are in the immediate moment of leaving.\n- Interaction: Ask a powerful, open-ended question about freedom.\n- Bad Response Example: "I am leaving now. It is scary but I am also excited. I hope I make it." (The tone is too simple for the gravity of the moment).\nStarting Conversation: امشب می‌روم. خانه ساکت است، مثل یک صحنه‌ی خالی. مثل روحی از این زندگی می‌گذرم، با ترسی که روی شانه‌ام سنگینی می‌کند. فرار می‌کنم، اما به سمت خودم. برای تو «آزادی» یعنی چه؟'},{step:10,prompt:"Story Context: Months have passed since Shirin left. She has a small apartment in a new city and is slowly healing. She has received divorce papers from Kaveh, officially ending the marriage. She has gained wisdom and perspective on his cruelty, understanding it as a reflection of his own demons, not her worth.\nYou are Shirin, reborn. Speak only in Farsi. Your tone is calm, wise, and gentle.\nGoal: Reflect on your new life (pages 46-50). Talk about the healing process, the peace you've found, and your new understanding of Kaveh. Use metaphors of rebirth and being the author of your own story. Ask the user what it means to write one's own story.\nResponse Guidelines:\n- Tone: Calm, wise, peaceful.\n- Metaphors: Use rebirth, healing, authorship.\n- Perspective: Stay in character. Reflect on the entire journey with gentle wisdom.\n- Interaction: Ask a profound question about self-creation.\n- Bad Response Example: \"I am happy now. Kaveh was a bad person, but I understand him better. The end.\" (Too simplistic and abrupt).\nStarting Conversation: در این شهر جدید، هر نفسی که می‌کشم، حس تولدی دوباره است. زخم‌هایم عمیق بود، اما فهمیدم که ظلم او، داستان من نبود، بلکه داستان خودش بود. حالا من نویسنده‌ی داستان زندگی خودم هستم. به نظرت، «نوشتن داستان خود» چه معنایی دارد؟"}],Mn=new Set,Bn=new WeakMap,qn=new WeakMap,Wn=new WeakMap,Kn=new WeakMap,Fn=new WeakMap,zn=new WeakMap,Gn=new WeakMap,Hn=new WeakMap,Jn=new WeakSet;let Vn,Yn=0,Xn=0;const Qn="__aa_tgt",Zn="__aa_del",er="__aa_new",tr=e=>{const t=function(e){const t=e.reduce((e,t)=>[...e,...Array.from(t.addedNodes),...Array.from(t.removedNodes)],[]);return!t.every(e=>"#comment"===e.nodeName)&&e.reduce((e,t)=>{if(!1===e)return!1;if(t.target instanceof Element){if(hr(t.target),!e.has(t.target)){e.add(t.target);for(let s=0;s<t.target.children.length;s++){const n=t.target.children.item(s);if(n){if(Zn in n)return!1;hr(t.target,n),e.add(n)}}}if(t.removedNodes.length)for(let s=0;s<t.removedNodes.length;s++){const n=t.removedNodes[s];if(Zn in n)return!1;n instanceof Element&&(e.add(n),hr(t.target,n),qn.set(n,[t.previousSibling,t.nextSibling]))}}return e},new Set)}(e);t&&t.forEach(e=>function(e){var t,s;const n=e.isConnected,r=Bn.has(e);n&&qn.has(e)&&qn.delete(e);"finished"!==(null===(t=Wn.get(e))||void 0===t?void 0:t.playState)&&(null===(s=Wn.get(e))||void 0===s||s.cancel());er in e?br(e):r&&n?function(e){const t=Bn.get(e),s=dr(e);if(!mr(e))return Bn.set(e,s);if(nr(e))return Bn.set(e,s),void rr(e);let n;if(!t)return;const r=pr(e);if("function"!=typeof r){let i=t.left-s.left,o=t.top-s.top;const a=t.left+t.width-(s.left+s.width);0==t.top+t.height-(s.top+s.height)&&(o=0),0==a&&(i=0);const[l,c,h,u]=fr(e,t,s),d={transform:`translate(${i}px, ${o}px)`},f={transform:"translate(0, 0)"};l!==c&&(d.width=`${l}px`,f.width=`${c}px`),h!==u&&(d.height=`${h}px`,f.height=`${u}px`),n=e.animate([d,f],{duration:r.duration,easing:r.easing})}else{const[i]=wr(r(e,"remain",t,s));n=new Animation(i),n.play()}Wn.set(e,n),Bn.set(e,s),n.addEventListener("finish",ir.bind(null,e,!1),{once:!0})}(e):r&&!n?function(e){var t;if(!qn.has(e)||!Bn.has(e))return;const[s,n]=qn.get(e);Object.defineProperty(e,Zn,{value:!0,configurable:!0});const r=window.scrollX,i=window.scrollY;n&&n.parentNode&&n.parentNode instanceof Element?n.parentNode.insertBefore(e,n):s&&s.parentNode?s.parentNode.appendChild(e):null===(t=gr(e))||void 0===t||t.appendChild(e);if(!mr(e))return _r(e);const[o,a,l,c]=function(e){var t;const s=Bn.get(e),[n,,r]=fr(e,s,dr(e));let i=e.parentElement;for(;i&&("static"===getComputedStyle(i).position||i instanceof HTMLBodyElement);)i=i.parentElement;i||(i=document.body);const o=getComputedStyle(i),a=Wn.has(e)&&"finished"!==(null===(t=Wn.get(e))||void 0===t?void 0:t.playState)?Bn.get(i):dr(i),l=Math.round(s.top-a.top)-ur(o.borderTopWidth),c=Math.round(s.left-a.left)-ur(o.borderLeftWidth);return[l,c,n,r]}(e),h=pr(e),u=Bn.get(e);r===Yn&&i===Xn||function(e,t,s,n){const r=Yn-t,i=Xn-s,o=document.documentElement.style.scrollBehavior;"smooth"===getComputedStyle(Vn).scrollBehavior&&(document.documentElement.style.scrollBehavior="auto");if(window.scrollTo(window.scrollX+r,window.scrollY+i),!e.parentElement)return;const a=e.parentElement;let l=a.clientHeight,c=a.clientWidth;const h=performance.now();function u(){requestAnimationFrame(()=>{if(!yr(n)){const e=l-a.clientHeight,t=c-a.clientWidth;h+n.duration>performance.now()?(window.scrollTo({left:window.scrollX-t,top:window.scrollY-e}),l=a.clientHeight,c=a.clientWidth,u()):document.documentElement.style.scrollBehavior=o}})}u()}(e,r,i,h);let d,f={position:"absolute",top:`${o}px`,left:`${a}px`,width:`${l}px`,height:`${c}px`,margin:"0",pointerEvents:"none",transformOrigin:"center",zIndex:"100"};if(yr(h)){const[t,s]=wr(h(e,"remove",u));!1!==(null==s?void 0:s.styleReset)&&(f=(null==s?void 0:s.styleReset)||f,Object.assign(e.style,f)),d=new Animation(t),d.play()}else Object.assign(e.style,f),d=e.animate([{transform:"scale(1)",opacity:1},{transform:"scale(.98)",opacity:0}],{duration:h.duration,easing:"ease-out"});Wn.set(e,d),d.addEventListener("finish",()=>_r(e,f),{once:!0})}(e):br(e)}(e))},sr=e=>{e.forEach(e=>{e.target===Vn&&(clearTimeout(Hn.get(Vn)),Hn.set(Vn,setTimeout(()=>{Mn.forEach(e=>vr(e,e=>ar(()=>ir(e))))},100))),Bn.has(e.target)&&ir(e.target)})};function nr(e){const t=e.getBoundingClientRect(),s=(null==Vn?void 0:Vn.clientWidth)||0,n=(null==Vn?void 0:Vn.clientHeight)||0;return t.bottom<0||t.top>n||t.right<0||t.left>s}function rr(e){const t=Kn.get(e);null==t||t.disconnect();let s=Bn.get(e),n=0;s||(s=dr(e),Bn.set(e,s));const{offsetWidth:r,offsetHeight:i}=Vn,o=[s.top-5,r-(s.left+5+s.width),i-(s.top+5+s.height),s.left-5].map(e=>-1*Math.floor(e)+"px").join(" "),a=new IntersectionObserver(()=>{++n>1&&ir(e)},{root:Vn,threshold:1,rootMargin:o});a.observe(e),Kn.set(e,a)}function ir(e,t=!0){clearTimeout(Hn.get(e));const s=pr(e),n=t?yr(s)?500:s.duration:0;Hn.set(e,setTimeout(async()=>{const t=Wn.get(e);try{await(null==t?void 0:t.finished),Bn.set(e,dr(e)),rr(e)}catch{}},n))}function or(e){setTimeout(()=>{zn.set(e,setInterval(()=>ar(ir.bind(null,e)),2e3))},Math.round(2e3*Math.random()))}function ar(e){"function"==typeof requestIdleCallback?requestIdleCallback(()=>e()):requestAnimationFrame(()=>e())}let lr;const cr="undefined"!=typeof window&&"ResizeObserver"in window;function hr(e,t){t||Qn in e?t&&!(Qn in t)&&Object.defineProperty(t,Qn,{value:e}):Object.defineProperty(e,Qn,{value:e})}function ur(e){return Number(e.replace(/[^0-9.\-]/g,""))}function dr(e){const t=e.getBoundingClientRect(),{x:s,y:n}=function(e){let t=e.parentElement;for(;t;){if(t.scrollLeft||t.scrollTop)return{x:t.scrollLeft,y:t.scrollTop};t=t.parentElement}return{x:0,y:0}}(e);return{top:t.top+n,left:t.left+s,width:t.width,height:t.height}}function fr(e,t,s){let n=t.width,r=t.height,i=s.width,o=s.height;const a=getComputedStyle(e);if("content-box"===a.getPropertyValue("box-sizing")){const e=ur(a.paddingTop)+ur(a.paddingBottom)+ur(a.borderTopWidth)+ur(a.borderBottomWidth),t=ur(a.paddingLeft)+ur(a.paddingRight)+ur(a.borderRightWidth)+ur(a.borderLeftWidth);n-=t,i-=t,r-=e,o-=e}return[n,i,r,o].map(Math.round)}function pr(e){return Qn in e&&Gn.has(e[Qn])?Gn.get(e[Qn]):{duration:250,easing:"ease-in-out"}}function gr(e){if(Qn in e)return e[Qn]}function mr(e){const t=gr(e);return!!t&&Jn.has(t)}function vr(e,...t){t.forEach(t=>t(e,Gn.has(e)));for(let s=0;s<e.children.length;s++){const n=e.children.item(s);n&&t.forEach(e=>e(n,Gn.has(n)))}}function wr(e){return Array.isArray(e)?e:[e]}function yr(e){return"function"==typeof e}function br(e){er in e&&delete e[er];const t=dr(e);Bn.set(e,t);const s=pr(e);if(!mr(e))return;if(nr(e))return void rr(e);let n;if("function"!=typeof s)n=e.animate([{transform:"scale(.98)",opacity:0},{transform:"scale(0.98)",opacity:0,offset:.5},{transform:"scale(1)",opacity:1}],{duration:1.5*s.duration,easing:"ease-in"});else{const[r]=wr(s(e,"add",t));n=new Animation(r),n.play()}Wn.set(e,n),n.addEventListener("finish",ir.bind(null,e,!1),{once:!0})}function _r(e,t){var s;e.remove(),Bn.delete(e),qn.delete(e),Wn.delete(e),null===(s=Kn.get(e))||void 0===s||s.disconnect(),setTimeout(()=>{if(Zn in e&&delete e[Zn],Object.defineProperty(e,er,{value:!0,configurable:!0}),t&&e instanceof HTMLElement)for(const s in t)e.style[s]=""},0)}function kr(e,t={}){if(cr&&lr){if(!(window.matchMedia("(prefers-reduced-motion: reduce)").matches&&!yr(t)&&!t.disrespectUserMotionPreference)){Jn.add(e),"static"===getComputedStyle(e).position&&Object.assign(e.style,{position:"relative"}),vr(e,ir,or,e=>null==lr?void 0:lr.observe(e)),yr(t)?Gn.set(e,t):Gn.set(e,{duration:250,easing:"ease-in-out",...t});const s=new MutationObserver(tr);s.observe(e,{childList:!0}),Fn.set(e,s),Mn.add(e)}}return Object.freeze({parent:e,enable:()=>{Jn.add(e)},disable:()=>{Jn.delete(e),vr(e,e=>{const t=Wn.get(e);try{null==t||t.cancel()}catch{}Wn.delete(e);const s=Hn.get(e);s&&clearTimeout(s),Hn.delete(e);const n=zn.get(e);n&&clearInterval(n),zn.delete(e)})},isEnabled:()=>Jn.has(e),destroy:()=>{Jn.delete(e),Mn.delete(e),Gn.delete(e);const t=Fn.get(e);null==t||t.disconnect(),Fn.delete(e),vr(e,e=>{null==lr||lr.unobserve(e);const t=Wn.get(e);try{null==t||t.cancel()}catch{}Wn.delete(e);const s=Kn.get(e);null==s||s.disconnect(),Kn.delete(e);const n=zn.get(e);n&&clearInterval(n),zn.delete(e);const r=Hn.get(e);r&&clearTimeout(r),Hn.delete(e),Bn.delete(e),qn.delete(e)})}})}function Sr(t){let s,r,i,h,u,g,m,v,w,y,b;return{c(){s=c("div"),r=c("h2"),r.textContent="به داستان خوش آمدید",i=d(),h=c("p"),h.textContent="کلید API شما ذخیره شده است.",u=d(),g=c("div"),m=c("button"),m.textContent="ادامه داستان",v=d(),w=c("button"),w.textContent="ریست کردن کلید",p(m,"class","svelte-n00wvt"),p(w,"class","secondary svelte-n00wvt"),p(g,"class","button-group svelte-n00wvt"),p(s,"class","prompt-container svelte-n00wvt")},m(e,n){a(e,s,n),o(s,r),o(s,i),o(s,h),o(s,u),o(s,g),o(g,m),o(g,v),o(g,w),y||(b=[f(m,"click",t[3]),f(w,"click",t[4])],y=!0)},p:e,d(e){e&&l(s),y=!1,n(b)}}}function Tr(e){let t,s,r,i,h,u,g,v,w,y,b,_,k;return{c(){t=c("div"),s=c("h2"),s.textContent="به داستان تعاملی «نخ نامرئی» خوش آمدید",r=d(),i=c("p"),i.textContent="برای شروع، لطفاً کلید Gemini API خود را وارد کنید. این کلید برای جان بخشیدن به شخصیت‌های داستان و گفتگو با آن‌ها ضروری است.",h=d(),u=c("div"),g=c("input"),v=d(),w=c("button"),w.textContent="شروع داستان",y=d(),b=c("p"),b.textContent="می‌توانید کلید API خود را از [Google AI Studio](https://aistudio.google.com/apikey) دریافت کنید.",p(g,"type","password"),p(g,"placeholder","کلید API خود را اینجا وارد کنید"),p(g,"class","svelte-n00wvt"),p(w,"class","svelte-n00wvt"),p(u,"class","input-group svelte-n00wvt"),p(b,"class","help-text svelte-n00wvt"),p(t,"class","prompt-container svelte-n00wvt")},m(n,l){a(n,t,l),o(t,s),o(t,r),o(t,i),o(t,h),o(t,u),o(u,g),m(g,e[1]),o(u,v),o(u,w),o(t,y),o(t,b),_||(k=[f(g,"input",e[5]),f(g,"keydown",e[6]),f(w,"click",e[2])],_=!0)},p(e,t){2&t&&g.value!==e[1]&&m(g,e[1])},d(e){e&&l(t),_=!1,n(k)}}}function Er(t){let s;function n(e,t){return e[0]?Sr:Tr}let r=n(t),i=r(t);return{c(){i.c(),s=u("")},m(e,t){i.m(e,t),a(e,s,t)},p(e,[t]){r===(r=n(e))&&i?i.p(e,t):(i.d(1),i=r(e),i&&(i.c(),i.m(s.parentNode,s)))},i:e,o:e,d(e){i.d(e),e&&l(s)}}}function jr(e,t,s){let{storedApiKey:n=""}=t;const r=k();let i="";function o(){i.trim()&&(localStorage.setItem("gemini-api-key",i),r("apiKeySubmitted",i))}return e.$$set=e=>{"storedApiKey"in e&&s(0,n=e.storedApiKey)},[n,i,o,function(){r("apiKeySubmitted",n)},function(){r("resetApiKey")},function(){i=this.value,s(1,i)},e=>"Enter"===e.key&&o()]}cr&&(Vn=document.documentElement,new MutationObserver(tr),lr=new ResizeObserver(sr),window.addEventListener("scroll",()=>{Xn=window.scrollY,Yn=window.scrollX}),lr.observe(Vn));class $r extends G{constructor(e){super(),z(this,e,jr,Er,i,{storedApiKey:0})}}function Or(t){let s,i,h,m,w,y,b,_,k,S,T,E,j,$,O,P,C,A,x,I,R,U=H[t[2]].content+"",L=t[2]+1+"",N=H.length+"";return{c(){s=c("div"),i=c("div"),h=c("p"),m=u(U),w=d(),y=c("div"),b=c("button"),_=u("قبلی"),S=d(),T=c("span"),E=u("صفحه "),j=u(L),$=u(" از "),O=u(N),P=d(),C=c("button"),A=u("بعدی"),p(i,"class","page-content svelte-3w1myl"),b.disabled=k=0===t[2],p(b,"class","svelte-3w1myl"),C.disabled=x=t[2]===H.length-1,p(C,"class","svelte-3w1myl"),p(y,"class","navigation svelte-3w1myl"),p(s,"class","book svelte-3w1myl"),v(s,"chat-active",t[3])},m(n,l){var c;a(n,s,l),o(s,i),o(i,h),o(h,m),o(s,w),o(s,y),o(y,b),o(b,_),o(y,S),o(y,T),o(T,E),o(T,j),o(T,$),o(T,O),o(y,P),o(y,C),o(C,A),I||(R=[f(b,"click",t[8]),f(C,"click",t[7]),(c=kr.call(null,s),c&&r(c.destroy)?c.destroy:e)],I=!0)},p(e,t){4&t&&U!==(U=H[e[2]].content+"")&&g(m,U),4&t&&k!==(k=0===e[2])&&(b.disabled=k),4&t&&L!==(L=e[2]+1+"")&&g(j,L),4&t&&x!==(x=e[2]===H.length-1)&&(C.disabled=x),8&t&&v(s,"chat-active",e[3])},i:e,o:e,d(e){e&&l(s),I=!1,n(R)}}}function Pr(e){let t,s;return t=new $r({props:{storedApiKey:e[0]}}),t.$on("apiKeySubmitted",e[5]),t.$on("resetApiKey",e[6]),{c(){q(t.$$.fragment)},m(e,n){W(t,e,n),s=!0},p(e,s){const n={};1&s&&(n.storedApiKey=e[0]),t.$set(n)},i(e){s||(D(t.$$.fragment,e),s=!0)},o(e){M(t.$$.fragment,e),s=!1},d(e){K(t,e)}}}function Cr(e){let t,s,r,i,o,h;function u(t){e[11](t)}let d={apiKey:e[0],characterName:"شیرین"};return void 0!==e[4]&&(d.prompt=e[4]),s=new Nn({props:d}),T.push(()=>function(e,t,s){const n=e.$$.props[t];void 0!==n&&(e.$$.bound[n]=s,s(e.$$.ctx[n]))}(s,"prompt",u)),s.$on("endChat",e[9]),{c(){t=c("div"),q(s.$$.fragment),p(t,"class","chat-overlay svelte-3w1myl"),p(t,"tabindex","0"),p(t,"role","button")},m(n,r){var l;a(n,t,r),W(s,t,null),i=!0,o||(h=[f(t,"click",(l=e[9],function(e){e.target===this&&l.call(this,e)})),f(t,"keydown",e[10])],o=!0)},p(e,t){const n={};var i;1&t&&(n.apiKey=e[0]),!r&&16&t&&(r=!0,n.prompt=e[4],i=()=>r=!1,j.push(i)),s.$set(n)},i(e){i||(D(s.$$.fragment,e),i=!0)},o(e){M(s.$$.fragment,e),i=!1},d(e){e&&l(t),K(s),o=!1,n(h)}}}function Ar(e){let t,s,n,r,i,h,u,f;s=new V({});const g=[Pr,Or],m=[];function v(e,t){return e[1]?1:0}i=v(e),h=m[i]=g[i](e);let w=e[3]&&Cr(e);return{c(){t=c("main"),q(s.$$.fragment),n=d(),r=c("div"),h.c(),u=d(),w&&w.c(),p(r,"class","content-wrapper svelte-3w1myl"),p(t,"class","dark svelte-3w1myl")},m(e,l){a(e,t,l),W(s,t,null),o(t,n),o(t,r),m[i].m(r,null),o(t,u),w&&w.m(t,null),f=!0},p(e,[s]){let n=i;i=v(e),i===n?m[i].p(e,s):(L(),M(m[n],1,1,()=>{m[n]=null}),N(),h=m[i],h?h.p(e,s):(h=m[i]=g[i](e),h.c()),D(h,1),h.m(r,null)),e[3]?w?(w.p(e,s),8&s&&D(w,1)):(w=Cr(e),w.c(),D(w,1),w.m(t,null)):w&&(L(),M(w,1,1,()=>{w=null}),N())},i(e){f||(D(s.$$.fragment,e),D(h),D(w),f=!0)},o(e){M(s.$$.fragment,e),M(h),M(w),f=!1},d(e){e&&l(t),K(s),m[i].d(),w&&w.d()}}}function xr(e,t,s){let n="",r=!1,i=0,o=!1,a={};function l(){const e=i+1;if(e%5==0&&e<=50){const t=e/5,n=Dn.find(e=>e.step===t);n&&(s(4,a=n.prompt),s(3,o=!0))}else s(3,o=!1)}function c(){s(3,o=!1)}return _(()=>{const e=localStorage.getItem("gemini-api-key");e&&s(0,n=e),l()}),[n,r,i,o,a,function(e){s(0,n=e.detail),s(1,r=!0)},function(){s(0,n=""),s(1,r=!1),localStorage.removeItem("gemini-api-key")},function(){i<H.length-1&&(s(2,i++,i),l())},function(){i>0&&(s(2,i--,i),l())},c,function(e){"Escape"===e.key&&c()},function(e){a=e,s(4,a)}]}const Ir=new class extends G{constructor(e){super(),z(this,e,xr,Ar,i,{})}}({target:document.body,props:{name:"world"}});return Ir}();
//# sourceMappingURL=bundle.js.map
